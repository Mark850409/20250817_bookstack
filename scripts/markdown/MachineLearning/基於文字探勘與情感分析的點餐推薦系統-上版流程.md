---
title: åŸºæ–¼æ–‡å­—æ¢å‹˜èˆ‡æƒ…æ„Ÿåˆ†æçš„é»é¤æ¨è–¦ç³»çµ±-ä¸Šç‰ˆæµç¨‹
updated: 2024-08-09 13:27:11Z
created: 2024-07-27 10:14:16Z
latitude: 25.0329694
longitude: 121.5654177
altitude: 0
tags:
  - ML
  - Order
  - Pipeline
  - Jenkins
  - python
---

# 1. åŸºæ–¼æ–‡å­—æ¢å‹˜èˆ‡æƒ…æ„Ÿåˆ†æçš„é»é¤æ¨è–¦ç³»çµ±-ä¸Šç‰ˆæµç¨‹

## 1.1. ç°¡ä»‹

ä½¿ç”¨`è‡ªå‹•åŒ–éƒ¨ç½²`ï¼ŒåŠ é€Ÿé–‹ç™¼ä¸Šç‰ˆæµç¨‹

## 1.2. ç›®éŒ„

- [1. åŸºæ–¼æ–‡å­—æ¢å‹˜èˆ‡æƒ…æ„Ÿåˆ†æçš„é»é¤æ¨è–¦ç³»çµ±-ä¸Šç‰ˆæµç¨‹](#1-åŸºæ–¼æ–‡å­—æ¢å‹˜èˆ‡æƒ…æ„Ÿåˆ†æçš„é»é¤æ¨è–¦ç³»çµ±-ä¸Šç‰ˆæµç¨‹)
  - [1.1. ç°¡ä»‹](#11-ç°¡ä»‹)
  - [1.2. ç›®éŒ„](#12-ç›®éŒ„)
  - [1.3. æ“ä½œæ­¥é©Ÿ(Gitlab)](#13-æ“ä½œæ­¥é©Ÿgitlab)
    - [1.3.1. éƒ¨ç½²æµç¨‹å‰é—œéµè…³æœ¬](#131-éƒ¨ç½²æµç¨‹å‰é—œéµè…³æœ¬)
      - [1.3.1.1. æ’°å¯«check\_commit\_message.sh](#1311-æ’°å¯«check_commit_messagesh)
    - [1.3.2. éƒ¨ç½²æµç¨‹é—œéµè…³æœ¬](#132-éƒ¨ç½²æµç¨‹é—œéµè…³æœ¬)
      - [1.3.2.1. æ’°å¯«.gitlab-ci.yml](#1321-æ’°å¯«gitlab-ciyml)
      - [1.3.2.2. æ’°å¯«custom-release-notes-generator.js](#1322-æ’°å¯«custom-release-notes-generatorjs)
      - [1.3.2.3. æ’°å¯«package.json](#1323-æ’°å¯«packagejson)
  - [1.4. æ“ä½œæ­¥é©Ÿ(Jenkins)](#14-æ“ä½œæ­¥é©Ÿjenkins)
    - [1.4.1. éƒ¨ç½²æµç¨‹å‰é—œéµè…³æœ¬](#141-éƒ¨ç½²æµç¨‹å‰é—œéµè…³æœ¬)
      - [1.4.1.1. æ’°å¯«pythonã€vueã€apacheçš„dockerfle](#1411-æ’°å¯«pythonvueapacheçš„dockerfle)
      - [1.4.1.2. æ’°å¯«docker-compose.yml](#1412-æ’°å¯«docker-composeyml)
    - [1.4.2. éƒ¨ç½²æµç¨‹é—œéµè…³æœ¬](#142-éƒ¨ç½²æµç¨‹é—œéµè…³æœ¬)
      - [1.4.2.1. æ’°å¯«dockerè‡ªå‹•åŒ–éƒ¨ç½²è…³æœ¬](#1421-æ’°å¯«dockerè‡ªå‹•åŒ–éƒ¨ç½²è…³æœ¬)
      - [1.4.2.2. æ’°å¯«Jenkins pipeline](#1422-æ’°å¯«jenkins-pipeline)
      - [1.4.2.3. æ’°å¯«å–®å…ƒæ¸¬è©¦æ‰€éœ€è…³æœ¬](#1423-æ’°å¯«å–®å…ƒæ¸¬è©¦æ‰€éœ€è…³æœ¬)
    - [1.4.3. éƒ¨ç½²å¾Œæµç¨‹æ‰€éœ€è…³æœ¬](#143-éƒ¨ç½²å¾Œæµç¨‹æ‰€éœ€è…³æœ¬)
      - [1.4.3.1. æ’°å¯«LINE NOTIFYéƒ¨ç½²å¾Œé€šçŸ¥è…³æœ¬](#1431-æ’°å¯«line-notifyéƒ¨ç½²å¾Œé€šçŸ¥è…³æœ¬)
      - [1.4.3.2. æ’°å¯«éƒµä»¶é€šçŸ¥æ¨¡æ¿](#1432-æ’°å¯«éƒµä»¶é€šçŸ¥æ¨¡æ¿)
  - [1.5. å•é¡Œè™•ç†](#15-å•é¡Œè™•ç†)
  - [1.6. å®Œæˆç•«é¢](#16-å®Œæˆç•«é¢)

## 1.3. æ“ä½œæ­¥é©Ÿ(Gitlab)

### 1.3.1. éƒ¨ç½²æµç¨‹å‰é—œéµè…³æœ¬

#### 1.3.1.1. æ’°å¯«check_commit_message.sh

```bash
#!/bin/bash
#+-------------------------------------è…³æœ¬èªªæ˜--------------------------------------------+
# æäº¤è¨Šæ¯æª¢æŸ¥è…³æœ¬
# ä½¿ç”¨æ–¹å¼: ./check_commit_message.sh
#
# (C) 2023 - markhsu - licensed under markweb License v1.
#
#+----------------------------------------------------------------------------------------+
# å–å¾—æäº¤è¨Šæ¯
COMMIT_MESSAGE=$1

# å®šç¾©HEADERæ­£è¦è¡¨é”å¼
PATTERN="^(feat|fix|docs|style|refactor|test|chore): .*"

# å®šç¾©FOOTERæ­£è¦è¡¨é”å¼
FOOTER_PATTERN="^redmine: #[0-9]+$"

echo "æˆ‘çš„æäº¤è¨Šæ¯æ˜¯:$COMMIT_MESSAGE"

# æ£€æŸ¥HEADERæäº¤è¨Šæ¯æ˜¯å¦ç¬¦åˆæ ¼å¼
if [[ ! "$COMMIT_MESSAGE" =~ $PATTERN ]]; then
    echo "
âŒ è«‹æª¢æŸ¥æ‚¨çš„æäº¤è¨Šæ¯æ˜¯å¦æ­£ç¢ºå–”~
ğŸ¸feat: æ–°å¢/ä¿®æ”¹åŠŸèƒ½ (Feature)
ğŸ›fix: ä¿®æ­£ Bug (bug fix)
âš¡ï¸ perf: æé«˜æ•ˆèƒ½çš„ç¨‹å¼ç¢¼ä¿®æ­£
ğŸ’¡refactor: é‡æ§‹ or å„ªåŒ–ï¼Œä¸å±¬æ–¼ bug ä¹Ÿä¸å±¬æ–¼æ–°å¢åŠŸèƒ½ç­‰
ğŸ¹release: æ–°å¢æ­£å¼é‡‹å‡ºçš„ release commit è¨Šæ¯
ğŸ’„style: ä¿®æ”¹ç¨‹å¼ç¢¼æ ¼å¼æˆ–é¢¨æ ¼ï¼Œä¸å½±éŸ¿åŸæœ‰é‹ä½œ
ğŸ’test: å¢åŠ æ¸¬è©¦åŠŸèƒ½
    "
    exit 1
fi


# æª¢æŸ¥æäº¤è¨Šæ¯ä¸­bodyçš„å†…å®¹æ˜¯å¦ç‚ºç©º
# BODY_CONTENT=$(grep '^body:' <<< "$COMMIT_MESSAGE" | sed 's/^body://')
# if [[ -z "${BODY_CONTENT// }" ]]; then
#     echo "âŒ è«‹æª¢æŸ¥æ‚¨çš„æäº¤è¨Šæ¯æ˜¯å¦æ­£ç¢ºå–”~
#     âŒ bodyä¸èƒ½ç‚ºç©º
#     ğŸ““ æ ¼å¼: bodyå¾Œé¢å†’è™ŸåŠ ä¸ŠåŠå½¢ç©ºç™½ï¼Œå¾Œé¢é–‹å§‹è¼¸å…¥è¨Šæ¯
#     "
#     exit 1
# fi

# æ£€æŸ¥FOOTERæäº¤è¨Šæ¯æ˜¯å¦ç¬¦åˆæ ¼å¼
# if [[ ! "$COMMIT_MESSAGE" =~ $FOOTER_PATTERN ]]; then
#     echo "
# âŒ è«‹æª¢æŸ¥æ‚¨çš„footeræäº¤è¨Šæ¯æ˜¯å¦æ­£ç¢ºå–”~
# ğŸ““ æ ¼å¼: REDMINE: #123
#     "
#     exit 1
# fi

# æ¶ˆæ¯æ­£ç¢ºå°±æœƒåˆ°é€™é‚Š
echo "âœ… æ­å–œï¼Œæ‚¨çš„æäº¤è¨Šæ¯æ˜¯æ­£ç¢ºçš„."
exit 0

```

<!--more-->
### 1.3.2. éƒ¨ç½²æµç¨‹é—œéµè…³æœ¬

#### 1.3.2.1. æ’°å¯«.gitlab-ci.yml

```yaml
cache:
  paths:
    - node_modules/

stages:
  - check_commit_message
  - semantic-release

# 31 æª¢æ ¸æäº¤è¨Šæ¯
check_commit_message:
  stage: check_commit_message
  script:
    - sh check_commit_message.sh "$CI_COMMIT_MESSAGE"
  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - '**/*'  # æª¢æŸ¥æ‰€æœ‰æ–‡ä»¶çš„æäº¤æ¶ˆæ¯

# 32 Change log ç‰ˆè™Ÿè®Šæ›´
semantic-release:
  stage: semantic-release
  image: node:latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  script:
    - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" >> .npmrc
    - npm install semver
    - npm install -g --save-dev conventional-changelog-conventionalcommits semantic-release @semantic-release/changelog @semantic-release/gitlab @semantic-release/git @semantic-release/npm @semantic-release/release-notes-generator @semantic-release/gitlab-config
    - export GL_TOKEN=${GL_TOKEN}
    - GL_TOKEN=${GL_TOKEN} npx semantic-release
  tags:
    - docker
```

#### 1.3.2.2. æ’°å¯«custom-release-notes-generator.js

```javascript
/*+-------------------------------------è…³æœ¬èªªæ˜--------------------------------------------+
* èªæ„åŒ–ç‰ˆæœ¬ç´€éŒ„ç”¢ç”Ÿè…³æœ¬
* ä½¿ç”¨æ–¹å¼:
* (C) 2023 - markhsu - licensed under markweb License v1.
+----------------------------------------------------------------------------------------+*/
// å°å…¥éœ€è¦çš„æ¨¡çµ„
const { execSync } = require('child_process');
const semver = require('semver');

// å‚³å…¥ç›¸é—œçš„åƒæ•¸ï¼Œä¸¦è‡ªå®šç¾©èªæ„åŒ–è…³æœ¬HEADER
module.exports = (pluginConfig, context) => {
  const { env } = context;
  const { CI_COMMIT_SHA: hash, CI_COMMIT_MESSAGE: rawMessage, CI_COMMIT_TAG: tag, CI_PROJECT_URL: projectUrl,CI_COMMIT_AUTHOR_NAME: AUTHOR_NAME,CI_COMMITTER_NAME: COMMITTER_NAME} = env;
  const typeEmojiMap = {
    feat: { emoji: 'âœ¨', text: 'æ–°å¢åŠŸèƒ½' },
    fix: { emoji: 'ğŸ', text: 'èª¿æ•´BUG' },
    docs: { emoji: 'ğŸ“ƒ', text: 'æ›´æ–°æ–‡ä»¶' },
    style: { emoji: 'ğŸŒˆ', text: 'èª¿æ•´æ¨£å¼' },
    refactor: { emoji: 'â™»ï¸', text: 'ç¨‹å¼ç¢¼é‡è³¼' },
    perf: { emoji: 'ğŸš€', text: 'æ•ˆèƒ½èª¿æ•´' },
    test: { emoji: 'ğŸ”¬', text: 'å–®å…ƒæ¸¬è©¦' },
    build: { emoji: 'ğŸ', text: 'éƒ¨ç½²' },
    ci: { emoji: 'ğŸ”§', text: 'CI' },
    chore: { emoji: 'ğŸ”¨', text: 'é›œé …' },
    revert: { emoji: 'âª', text: 'é€€ç‰ˆ' },
    wip: { emoji: 'ğŸš§', text: 'é€²è¡Œä¸­' }
  };

  // ä½¿ç”¨Gitå‘½ä»¤å–å¾—ä½œè€…
  const authorName = execSync('git log --format="%an" -n 2 | tail -n 1').toString().trim();

  // ä½¿ç”¨Gitå‘½ä»¤å–å¾—æ¨™ç±¤
  let latestTag;
  try {
    latestTag = execSync('git describe --tags --abbrev=0').toString().trim();
  } catch (error) {
    // å–å¾—æ¨™ç±¤å¤±æ•—ä½¿ç”¨åˆå§‹åŒ–ç‰ˆæœ¬
    latestTag = 'v1.0.0';
  }

  console.log("latestTag:"+latestTag)


  // å–å¾—æäº¤è¨Šæ¯çš„REDMINEå–®è™Ÿ
  const redmineIssue = rawMessage.match(/(REDMINE: #\d+)/i)?.[0];
  console.log("redmineIssue:"+redmineIssue)

  let redmineIssueNumber =''
  let redmineIssueLink =''

  if (redmineIssue!=""&&redmineIssue!=null) {
    console.log("REDMINEå–®è™Ÿåˆ¤æ–·!!!")

    // å–å¾—æäº¤è¨Šæ¯çš„REDMINEå–®è™Ÿä¸åŒ…å«å‰ç¶´(REDMINE:)
    redmineIssueNumber = redmineIssue ? redmineIssue.split(':')[1].trim().toLowerCase():""
    console.log("redmineIssueNumber:"+redmineIssueNumber)

    // ç”¢ç”ŸRedmineé€£çµ(ä¸åŒ…å«#)
    redmineIssueLink = redmineIssueNumber ? `https://markweb.idv.tw:18443/issues/${redmineIssueNumber.replace('#', '')}`:"";
    console.log("redmineIssueLink:"+redmineIssueLink)
  }

  // æ ¹æ“šæäº¤é¡å‹å®šç¾©è·³ç‰ˆè¦å‰‡(fixã€featã€style...)
  const releaseType = (rawMessage.split(':')[0].trim().toLowerCase());
  console.log("releaseType:"+releaseType)

  // å¦‚æœæ˜¯featå°±è·³minorç‰ˆè™Ÿï¼Œå…¶ä»–çš„å°±è·³patch
  const incrementType = releaseType=="feat" ? 'minor' : 'patch';
  console.log("incrementType:"+incrementType)


   // æ ¹æ“šä¸åŒæäº¤é¡å‹åŠ ä¸Šä¸åŒçš„è¡¨æƒ…ç¬¦è™Ÿ
  const message = rawMessage.split(':')[1].trim();
  console.log("åŸå§‹è¨Šæ¯:"+message)
  console.log("åŸå§‹åˆ‡å‰²è¨Šæ¯:"+rawMessage.split(':'))
  console.log("æäº¤é¡å‹:"+rawMessage.split(':')[0])
  console.log("è¨Šæ¯å…§å®¹:"+rawMessage.split(':')[1])

  // åˆ¤æ–­æäº¤æ¶ˆæ¯æ˜¯å¦åŒ…å« "BREAKING CHANGE" é—œéµå­—çš„æ­£è¦è¡¨é”å¼
  const breakingChangeRegex = /BREAKING\s*CHANGE(S)?/i;

  console.log("æäº¤æ¶ˆæ¯æœ‰breakingChangeå—? "+breakingChangeRegex.test(message))

  // æ£€æŸ¥æäº¤æ¶ˆæ¯æ˜¯å¦åŒ…å« "BREAKING CHANGE" é—œéµå­—ï¼Œæœ‰å°±è·³å¤§ç‰ˆè™Ÿï¼Œå¦å‰‡å°±ç…§é è¨­è¦å‰‡
  const hasBreakingChange = breakingChangeRegex.test(message)

  // å¦‚æœæ˜¯ç¬¬ æ¬¡ç”Ÿæˆæ¨™ç±¤ï¼Œç‰ˆè™Ÿè¨­ç‚ºV1.0.0ï¼Œä¸”è·³æ¿è¦å‰‡æ˜¯å°ç‰ˆè™Ÿ
  //const nextVersion = latestTag === 'v1.0.0' ? '1.0.0' : semver.inc(latestTag,incrementType);
  let nextVersion=''
  if(latestTag === 'v1.0.0'){
    nextVersion='1.0.0'
    console.log("é è¨­åˆå§‹ç‰ˆè™Ÿ:"+nextVersion)
  }
  else if(hasBreakingChange){
    nextVersion=semver.inc(latestTag,'major')
    console.log("breakingChangeå¤§ç‰ˆè™Ÿ:"+nextVersion)
  }
  else{
    nextVersion=semver.inc(latestTag,incrementType)
    console.log("å…¶ä»–ç‰ˆè™Ÿ:"+nextVersion)
  }

  // ç”Ÿæˆç‰ˆæœ¬è™Ÿç¢¼é€£çµ
  const tagLink = `[v${nextVersion}](${projectUrl}/-/compare/${latestTag}...v${nextVersion})`;

  // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… "BREAKING CHANGE" å†’å·åé¢çš„æ–‡æœ¬å†…å®¹
  const breakingChangeRegexContent = /BREAKING\s+CHANGE:\s*(.*)/i;
  const match = breakingChangeRegexContent.exec(rawMessage);
  let breakingChangeDescription=''
  // å¦‚æœæ‰¾åˆ°åŒ¹é…é¡¹ï¼Œåˆ™æ‰“å°å†’å·å³è¾¹çš„æ–‡æœ¬å†…å®¹
  if (match && match.length > 1) {
    breakingChangeDescription = match[1].trim();
    console.log("Breaking Change Description:", breakingChangeDescription);
  } else {
    console.log("No Breaking Change description found.");
  }

  // outputçš„è¨Šæ¯ä¸è¦åŒ…å«redmine(ç„¡è«–å¤§å°å¯«)
  new_message = message.replace(/(BREAKING\s*CHANGE(S)?)|(REDMINE)/gi, '');
  console.log("æ–°çš„è¨Šæ¯æ˜¯:"+new_message)

  //å–å¾—æäº¤è¨Šæ¯é¡å‹
  const messageType = rawMessage.split(':')[0].trim();
  //ä¸²è¯æˆ{ emoji, text }æ ¼å¼
  const { emoji, text } = typeEmojiMap[messageType] || { emoji: 'ğŸ’¡', text: 'æ­¤æ¬¡ç‚ºé‡å¤§è®Šæ›´ç‰ˆæœ¬ - '+"("+breakingChangeDescription+")" };

  // æ—¥æœŸæ ¼å¼ç‚º YYYY-MM-DD
  const currentDate = new Date().toISOString().split('T')[0];
  // åŠ å…¥ç‰ˆæ¬Šè²æ˜
  const copyright = `
  > æœ¬æ–‡ä»¶æ¡è‡ªå‹•åŒ–ç”Ÿæˆï¼Œå¦‚éœ€è¦æ›´å¤šä¿¡æ¯ï¼Œè«‹æŸ¥çœ‹semantic-releaseã€‚
  `;
  // è·å–å€’æ•°ç¬¬ æ¬¡æäº¤çš„æ—¶é—´æˆ³
  const commitTimestamp = execSync('git log -2 --pretty=format:%ct | tail -1').toString().trim();

  // è·å–æäº¤æ—¶é—´
  const commitDate = new Date(commitTimestamp * 1000); // å°†æ—¶é—´æˆ³è½¬æ¢ä¸ºæ—¥æœŸå¯¹è±¡
  commitDate.setHours(commitDate.getHours() + 8); // è°ƒæ•´æ—¶åŒºä¸º GMT+8
  const formattedCommitDate = commitDate.toISOString().replace('T', ' ').replace(/\.\d+Z$/, '');

  // è¼¸å‡ºæ ¼å¼ç‚º-è¨Šæ¯(SHA)
  let output = `- ${new_message} (${hash.slice(0, 7)})`;

  let final_output =``;

  // åˆ¤æ–·çœ‹éœ€ä¸éœ€è¦åŠ ä¸ŠREDMINE
  if (redmineIssue!=""&&redmineIssue!=null) {
    console.log("REDMINEå–®è¨Šæ¯åˆ¤æ–·!!!")
    final_output=`## ${tagLink} (${currentDate})\n\n ### ${emoji} ${text} ([${redmineIssueNumber}](${redmineIssueLink})) \n\n${output}ï¼by ${authorName} - [${formattedCommitDate}]`
  }
  else{
    console.log("æ²’æœ‰REDMINEå–®è¨Šæ¯åˆ¤æ–·!!!")
    final_output=`## ${tagLink} (${currentDate})\n\n ### ${emoji} ${text} \n\n${output}ï¼${authorName} - [${formattedCommitDate}]`
  }
  // ä¸²æ¥è¨Šæ¯å¾Œå›å‚³
  return final_output
};
```

#### 1.3.2.3. æ’°å¯«package.json

```json
{
    "name": "myflaskCrudVue",
    "version": "1.3.2",
    "author": "markhsu",
    "private": true,
    "workspaces": [
        "packages/*"
    ],
    "scripts": {
        "semantic-release": "semantic-release"
    },
    "repository": {
        "type": "git",
        "url": "git+https://markweb.idv.tw:10443/dockercomposeteam/flaskcrudvue_localhost.git"
    },
    "release": {
        "extends": "@semantic-release/gitlab-config",
        "plugins": [
            [
                "@semantic-release/commit-analyzer",
                {
                    "path": "./custom-release-notes-generator.js"
                }
            ],
            [
                "@semantic-release/release-notes-generator",
                {
                    "preset": "conventionalcommits",
                    "parserOpts": {
                        "noteKeywords": [
                            "BREAKING CHANGE",
                            "BREAKING CHANGES",
                            "BREAKING"
                        ]
                    }
                }
            ],
            "@semantic-release/gitlab"
        ],
        "prepare": [
            "@semantic-release/changelog",
            "@semantic-release/npm",
            {
                "path": "@semantic-release/git",
                "assets": [
                    "package.json",
                    "package-lock.json",
                    "CHANGELOG.md"
                ],
                "message": "${nextRelease.type === 'major' ? 'ğŸ› ï¸chore(release):é€™æ¬¡æ˜¯é‡å¤§ç‰ˆæ›´!!!' : 'ğŸfeat/fix(release):é€™åªæ˜¯å°ç‰ˆæ›´!!!'}\n\n v${nextRelease.version} æ–°çš„å°ˆæ¡ˆç‰ˆæœ¬å·²é‡‹å‡º!!! [skip ci]"
            }
        ],
        "generateNotes": {
            "path": "./custom-release-notes-generator.js"
        }
    },
    "dependencies": {
        "cors": "^2.8.5",
        "semver": "^7.6.3"
    }
}

```

## 1.4. æ“ä½œæ­¥é©Ÿ(Jenkins)

### 1.4.1. éƒ¨ç½²æµç¨‹å‰é—œéµè…³æœ¬

#### 1.4.1.1. æ’°å¯«pythonã€vueã€apacheçš„dockerfle

```docker 
FROM php:7.4-apache
RUN apt-get update && apt-get upgrade -y && apt install vim -y
RUN a2enmod rewrite && a2enmod ssl && a2enmod socache_shmcb && a2enmod headers
```

```docker
# ä½¿ç”¨ Python åŸºç¤æ˜ åƒ
FROM python:3.8.11-slim

# è¨­ç½®å·¥ä½œç›®éŒ„
WORKDIR /usr/src/app

# è¤‡è£½å¾Œç«¯æºä»£ç¢¼åˆ°å·¥ä½œç›®éŒ„
COPY backend/requirements.txt ./
COPY backend/ ./backend/

# å®‰è£å¾Œç«¯ä¾è³´
RUN pip install -r requirements.txt

# æš´éœ² Flask æ‡‰ç”¨ç¨‹åºçš„ç«¯å£
EXPOSE 5000

# å•Ÿå‹• Flask æ‡‰ç”¨ç¨‹åº
CMD ["python", "app.py"]

```

```docker
# base image
FROM node:20.12.2-alpine

# set working directory
WORKDIR /app

# add `/app/node_modules/.bin` to $PATH
ENV PATH /app/node_modules/.bin:$PATH

# g++ compiler for fibers and sass
RUN apk add --no-cache python3 make g++

# install app dependencies
COPY frontend /app
COPY frontend/package.json /app/package.json
COPY frontend/package-lock.json /app/package-lock.json
RUN npm install
RUN npm install @vue/cli -g

CMD npm run serve

```

#### 1.4.1.2. æ’°å¯«docker-compose.yml

```yaml
version: "3.3"
services:
  frontend:
    image: ${IMAGE_NAME_VUE}
    container_name: vuewithflask_frontend
    volumes:
      - '/media/markhsu/Data/DockerProtainer/vueWithFlask/frontend:/app'
      - '/app/node_modules'
    ports:
      - 9005:8080
    restart: always
    environment:
      - CHOKIDAR_USEPOLLING=true
      - NODE_ENV=development
      - BACKEND_SERVICE_URL=https://markweb.idv.tw:28443
      - VUE_GATEWAY_URL=https://markweb.idv.tw:30443
    networks:
      - api_bridge

  backend:
    image: ${IMAGE_NAME_PYTHON}
    container_name: vuewithflask_backend
    volumes:
      - /media/markhsu/Data/DockerProtainer/vueWithFlask/backend:/usr/src/app
    ports:
      - 9006:5000
    environment:
      - FLASK_ENV=development
      - APP_SETTINGS=project.config.DevelopmentConfig
      - SECRET_KEY=my_precious
    networks:
      - api_bridge
    restart: always

  db:
    image: mysql:5.7
    container_name: vuewithflask_db
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    ports:
      - '9007:3306'
    volumes:
      - /media/markhsu/Data/DockerProtainer/vueWithFlask/db_data:/var/lib/mysql
    restart: always
    networks:
      - api_bridge

  # phpmyadmin
  phpmyadmin:
    depends_on:
      - db
    image: phpmyadmin
    container_name: vuewithflask_phpmyadmin
    restart: always
    ports:
      - '9009:80'
    environment:
      PMA_HOST: db
      PMA_ABSOLUTE_URI: https://markweb.idv.tw:27443
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    networks:
      - api_bridge

  apache:
    image: ${IMAGE_NAME_APACHE}
    container_name: vuewithflask_apache
    restart: always
    ports:
      - '30443:30443'
      - '28443:443'
      - '27443:27443'
    volumes:
      - /media/markhsu/Data/DockerProtainer/vueWithFlask/etc/apache2:/etc/apache2
      - /media/markhsu/Data/DockerProtainer/vueWithFlask/etc/letsencrypt/live/markweb.idv.tw:/etc/letsencrypt/live/markweb.idv.tw

networks:
  api_bridge:
    driver: bridge

```

### 1.4.2. éƒ¨ç½²æµç¨‹é—œéµè…³æœ¬

#### 1.4.2.1. æ’°å¯«dockerè‡ªå‹•åŒ–éƒ¨ç½²è…³æœ¬

```bash
#!/bin/bash
#+-------------------------------------è…³æœ¬èªªæ˜--------------------------------------------+
# è‡ªå‹•åŒ–éƒ¨ç½²åˆ°HARBORï¼Œä¸¦è‡ªå‹•ç”Ÿæˆç‰ˆè™Ÿ
# ä½¿ç”¨æ–¹å¼: ./deploy_harbor.sh
#
# (C) 2023 - markhsu - licensed under markweb License v1.
#
#+----------------------------------------------------------------------------------------+

#+----------------------------------------------------------------------------------------+
#                                     æ¥æ”¶åƒæ•¸
#+----------------------------------------------------------------------------------------+
# æå–å‚æ•°
HARBOR_REGISTRY="$1"
HARBOR_USERNAME="$2"
HARBOR_PASSWORD="$3"
INITIAL_VERSION="$4"
image_name="$5"
dockerfile="$6"
HARBOR_PROJECT="$7"
#+----------------------------------------------------------------------------------------+
#                                     æŠ“å–ç‰ˆè™Ÿ
#+----------------------------------------------------------------------------------------+
#å¦‚æœç‰ˆè™Ÿç‚ºç©ºå‰‡çµ¦åˆå§‹ç‰ˆè™Ÿï¼Œå¦å‰‡å°±æŠ“å–gitç‰ˆè™Ÿ
version=$(git describe --tags --abbrev=0 | sed 's/^v//')
echo "Gitç‰ˆè™Ÿæ˜¯ï¼š$version"
if [ -z "$version" ]; then
    version="${INITIAL_VERSION}"
    echo "åˆå§‹ç‰ˆè™Ÿæ˜¯ï¼š$version"
fi

#+----------------------------------------------------------------------------------------+
#                                     æŠ“å–commit message
#+----------------------------------------------------------------------------------------+
#æŠ“å–commit messageä¾†åˆ¤æ–·è¦è·³å¤§ç‰ˆè™Ÿã€ä¸­ç‰ˆè™Ÿã€å°ç‰ˆè™Ÿ
commit_message=$(git log --format=%B -n 2 | tail -n 1)
echo "æäº¤è¨Šæ¯ç‚ºï¼š$commit_message"
#é‡å¤§è®Šæ›´
if echo "$commit_message" | grep -q "BREAKING CHANGE"; then
    version_parts=$(echo $version | cut -d"." -f 1)
    echo "æäº¤çš„é‡å¤§æ›´æ–°ç‰ˆè™Ÿæ˜¯ï¼š$version_parts"
    major=$(($version_parts+1))
    echo "å¤§ç‰ˆè™Ÿæ˜¯ï¼š$major"
    version="${major}.0.0"
    echo "ä¸²æ¥ç‰ˆè™Ÿæ˜¯ï¼š$version"
#feat
elif echo "$commit_message" | grep -q "feat"; then
    version_parts=$(echo $version | cut -d"." -f 2)
    echo "å–å‡ºçš„featç‰ˆè™Ÿæ˜¯ï¼š$version_parts"
    minor=$(($version_parts+1))
    echo "ä¸­ç‰ˆè™Ÿæ˜¯ï¼š$minor"
    version="${version_parts}.${minor}.0"
    echo "ä¸²æ¥ç‰ˆè™Ÿæ˜¯ï¼š$version"
#fix
elif echo "$commit_message" | grep -q "fix"; then
    version_parts_major=$(echo $version | cut -d"." -f 1)
    version_parts_minor=$(echo $version | cut -d"." -f 2)
    version_parts_patch=$(echo $version | cut -d"." -f 3)
    echo "æäº¤çš„fixå¤§ç‰ˆè™Ÿæ˜¯ï¼š$version_parts_major"
    echo "æäº¤çš„fixä¸­ç‰ˆè™Ÿæ˜¯ï¼š$version_parts_minor"
    echo "æäº¤çš„fixå°ç‰ˆè™Ÿæ˜¯ï¼š$version_parts_patch"
    patch=$(($version_parts_patch+1))
    echo "å°ç‰ˆè™Ÿæ˜¯ï¼š$patch"
    version="${version_parts_major}.${version_parts_minor}.${patch}"
    echo "ä¸²æ¥ç‰ˆè™Ÿæ˜¯ï¼š$version"
#å…¶ä»–é¡å‹
else
    version_parts_major=$(echo $version | cut -d"." -f 1)
    version_parts_minor=$(echo $version | cut -d"." -f 2)
    version_parts_patch=$(echo $version | cut -d"." -f 3)
    echo "æäº¤çš„fixå¤§ç‰ˆè™Ÿæ˜¯ï¼š$version_parts_major"
    echo "æäº¤çš„fixä¸­ç‰ˆè™Ÿæ˜¯ï¼š$version_parts_minor"
    echo "æäº¤çš„fixå°ç‰ˆè™Ÿæ˜¯ï¼š$version_parts_patch"
    patch=$(($version_parts_patch+1))
    echo "å°ç‰ˆè™Ÿæ˜¯ï¼š$patch"
    version="${version_parts_major}.${version_parts_minor}.${patch}"
    echo "ä¸²æ¥ç‰ˆè™Ÿæ˜¯ï¼š$version"
fi

echo "æå–çš„æª”æ¡ˆåç¨±ï¼š$image_name"
echo "Dockerfileæª”æ¡ˆåç¨±ï¼š$dockerfile"

#+----------------------------------------------------------------------------------------+
#                                     æŠ“å–git commit sha
#+----------------------------------------------------------------------------------------+
commit_sha=$(git rev-parse --short HEAD)
echo "git commit shaï¼š$commit_sha"
version="v${version}-${commit_sha}"
echo "æœ€çµ‚ä¸²æ¥ç‰ˆè™Ÿç‚ºï¼š$version"

#+----------------------------------------------------------------------------------------+
#                                     éƒ¨ç½²åˆ°harbor
#+----------------------------------------------------------------------------------------+
echo "DEBUG: docker build -t ${HARBOR_REGISTRY}/${HARBOR_PROJECT}/my${image_name}:$version --label "commit_message=${commit_message}" --build-arg COMMIT_SHA=${commit_sha} -f $dockerfile"

# æ–°å¢.envæ–‡ä»¶
touch .env

echo "MYSQL_ROOT_PASSWORD=root" >> .env
echo "MYSQL_DATABASE=wordpress" >> .env
echo "MYSQL_USER=mark" >> .env
echo "MYSQL_PASSWORD=mark850409" >> .env

# å°‡image nameå¯«å…¥.envæ–‡ä»¶
# æ ¹æ® imagename è¿›è¡Œåˆ¤æ–­
if [ "$image_name" = "python" ]; then
    echo "IMAGE_NAME_PYTHON=${HARBOR_REGISTRY}/${HARBOR_PROJECT}/mypython:$version" >> .env
    echo "WordPress image added to .env"
elif [ "$image_name" = "apache" ]; then
    echo "IMAGE_NAME_APACHE=${HARBOR_REGISTRY}/${HARBOR_PROJECT}/myapache:$version" >> .env
    echo "Apache image added to .env"
elif [ "$image_name" = "vue" ]; then
    echo "IMAGE_NAME_VUE=${HARBOR_REGISTRY}/${HARBOR_PROJECT}/myvue:$version" >> .env
    echo "PhpMyAdmin image added to .env"
else
    echo "Unknown image name. Please provide valid image name: wordpress, apache, or phpmyadmin"
fi

docker build -t ${HARBOR_REGISTRY}/${HARBOR_PROJECT}/my${image_name}:$version --label "commit_message=${commit_message}" --build-arg COMMIT_SHA=${commit_sha} -f $dockerfile .
docker login -u ${HARBOR_USERNAME} -p ${HARBOR_PASSWORD} ${HARBOR_REGISTRY}
docker push ${HARBOR_REGISTRY}/${HARBOR_PROJECT}/my${image_name}:$version
```

#### 1.4.2.2. æ’°å¯«Jenkins pipeline

```groovy
pipeline {
    agent any

    environment {
        GITLAB_CREDENTIALS = credentials('gitlab') // GitLab èªè­‰
        SONARQUBE_CREDENTIALS = credentials('sonarqube') // SonarQube èªè­‰
        SONARQUBE_URL = 'markweb.idv.tw:16443' // SonarQube ä¼ºæœå™¨ URL
        SONAR_PROJECT_KEY = '20240727_SonarQube_flaskcrudvue' // SonarQube å°ˆæ¡ˆé‡‘é‘°
        SONAR_PROJECT_NAME = '20240727_SonarQube_flaskcrudvue' // SonarQube å°ˆæ¡ˆåç¨±
        SOURCE_CODE_GIT_URL='ssh://git@markweb.idv.tw:2222/dockercomposeteam/flaskcrudvue_localhost.git' // GitLab URL
        PYTHON_ENV = "venv"  // è¨­å®š Python ç’°å¢ƒè·¯å¾‘
        HARBOR_REGISTRY="markweb.idv.tw:29443" // Harborå€‰åº«åœ°å€
        HARBOR_USERNAME="admin" // Harborç”¨æˆ·å
        HARBOR_PASSWORD="admin" // Harborå¯†ç¢¼
        HARBOR_PROJECT="myvuewithflaskrepo" // Harborå€‰åº«åç¨±
        INITIAL_VERSION="1.0.0" // gitåˆå§‹åŒ–ç‰ˆæœ¬è™Ÿ
        RSYNC_TARGET_FRONTEND_DIR = '/Backup/DockerProtainer/vueWithFlask/frontend'// å®šç¾© rsync ç›®æ¨™ç›®éŒ„
        RSYNC_SOURCE_FRONTEND_DIR = '${WORKSPACE}/frontend' // å®šç¾© rsync æºç›®éŒ„ï¼ˆå°ˆæ¡ˆç›®éŒ„ï¼‰
        RSYNC_TARGET_BACKEND_DIR = '/Backup/DockerProtainer/vueWithFlask/backend'// å®šç¾© rsync ç›®æ¨™ç›®éŒ„
        RSYNC_SOURCE_BACKEND_DIR = '${WORKSPACE}/backend' // å®šç¾© rsync æºç›®éŒ„ï¼ˆå°ˆæ¡ˆç›®éŒ„ï¼‰
    }

    stages {
        stage('å¾gitlabæ‹‰å–å°ˆæ¡ˆ') {
            steps {
                script {
                    // å¾ GitLab æ‹‰å–å°ˆæ¡ˆ
                    git url: SOURCE_CODE_GIT_URL, credentialsId: 'gitlab'
                }
            }
        }

        stage('SonarQubeåŸå§‹ç¢¼å¼±é»æƒæå ±å‘Š') {
            steps {
                script{
                    def version
                    try {
                        version = sh(script: "git describe --tags", returnStdout: true).trim()
                    } catch (Exception e) {
                        // å¦‚æœæ²’æœ‰æ¨™ç±¤ï¼Œä½¿ç”¨é è¨­ç‰ˆæœ¬è™Ÿ
                        version = "1.0.0"
                    }
                    withSonarQubeEnv('sonarqube') {
                    sh """
                    ${SONAR_SCANNER_HOME}sonar-scanner \
                    -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
                    -Dsonar.projectVersion=${version} \
                    -Dsonar.sources=. \
                    -Dsonar.host.url=https://${SONARQUBE_URL} \
                    -Dsonar.login=$SONARQUBE_TOKEN
                    """
                }
                }

            }
        }


        stage('å®‰è£å¥—ä»¶') {
            steps {
                sh '''
                apt-get install python3-venv -y
                apt-get install -y zip
                '''
            }
        }


        stage('è¨­å®špythonç’°å¢ƒè®Šæ•¸') {
            steps {
                sh '''
                python3 -m venv $PYTHON_ENV
                source $PYTHON_ENV/bin/activate
                pip install -r requirements.txt
                pip install pyinstaller  # å®‰è£ pyinstaller
                '''
            }
        }

        stage('å»ºç½®ALLUREå–®å…ƒæ¸¬è©¦ç’°å¢ƒ') {
            steps {
                sh '''
                # å»ºç«‹è™›æ“¬ç’°å¢ƒ
                source $PYTHON_ENV/bin/activate

                # ç¢ºä¿æ‰€æœ‰ä¾è³´é …éƒ½å·²å®‰è£
                pip install -r ${WORKSPACE}/requirements.txt

                # é‹è¡Œ pytest
                pytest -s -q ${WORKSPACE}/test_math_operations.py --alluredir=${WORKSPACE}/allure-results --clean-alluredir
                '''
            }
        }

        stage('ç”¢ç”ŸALLUREå–®å…ƒæ¸¬è©¦å ±å‘Š') {
            steps {
                sh '''
                # å•Ÿå‹•è™›æ“¬ç’°å¢ƒ
                source $PYTHON_ENV/bin/activate

                # ç¢ºä¿ ${ALLURE_HOME} è®Šæ•¸è¨­ç½®æ­£ç¢º
                echo "ALLURE_HOME is set to $ALLURE_HOME"

                # åˆªé™¤èˆŠå ±å‘Šç›®éŒ„ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                rm -rf ${WORKSPACE}/allure-report

                # ç”Ÿæˆæ–°çš„ Allure å ±å‘Š
                ${ALLURE_HOME}allure generate ${WORKSPACE}/allure-results -o ${WORKSPACE}/allure-report
                '''
            }
        }

        stage('æ‰“åŒ…allure-report') {
            steps {
                // å°‡æ‰“åŒ…çµæœå­˜æ”¾åˆ°Jenkinså·¥ä½œç›®éŒ„ä¸‹çš„allure-report
                 allure([
                    includeProperties: false,
                    jdk: '',
                    results: [[path: '${WORKSPACE}/allure-report']]
                ])
            }
        }

        stage('æ‰“åŒ…Pythonè…³æœ¬') {
            steps {
                sh '''
                # å•Ÿå‹•è™›æ“¬ç’°å¢ƒ
                source $PYTHON_ENV/bin/activate

                # æ‰“åŒ…éœ€è¦çš„pythonæª”æ¡ˆ
                pyinstaller --onefile backend/app.py

                # å°å‡ºæ‰“åŒ…ç›®éŒ„ï¼Œç¢ºèªæª”æ¡ˆæ˜¯å¦å­˜åœ¨
                ls -l dist

                # é‡å‘½åæ‰“åŒ…çµæœ
                mv dist/app dist/app.exe
                '''
            }
        }
         stage('éƒ¨ç½²è…³æœ¬') {
            steps {
               script {
                    def dockerfiles = sh(script: 'find dockerfiles -mindepth 2 -maxdepth 2 -type f -name "Dockerfile_*"', returnStdout: true).trim().split('\n')
                    echo "dockerfiles: ${dockerfiles}"
                    for (def dockerfile in dockerfiles) {
                        def imageName = dockerfile.tokenize('_')[-1].tokenize('/')[0]
                        echo "Image Name: ${imageName}"
                        echo "Dockerfile: ${dockerfile}"
                        sh "sh deploy_harbor.sh ${HARBOR_REGISTRY} ${HARBOR_USERNAME} ${HARBOR_PASSWORD} ${INITIAL_VERSION} ${imageName} ${dockerfile} ${HARBOR_PROJECT}"
                    }
                }

            }
        }

        stage('åœæ­¢ä¸¦ç§»é™¤å®¹å™¨') {
            steps {
                script {
                    def containers = ['vuewithflask_apache', 'vuewithflask_backend', 'vuewithflask_db','vuewithflask_frontend','vuewithflask_phpmyadmin']
                    for (container in containers) {
                        def containerId = sh(returnStdout: true, script: "docker ps -aq --filter name=$container").trim()
                        if (containerId) {
                            sh "docker stop $containerId"
                            sh "docker rm $containerId"
                        } else {
                            echo "å®¹å™¨ $container ä¸å­˜åœ¨,è·³éç§»é™¤"
                        }
                    }
                }
            }
        }

        stage('å•Ÿå‹•å®¹å™¨') {
            steps {
                script {
                     sh 'docker-compose up -d --build'
                }
            }
        }

        stage('ä½¿ç”¨ rsync åŒæ­¥å°ˆæ¡ˆåˆ°ç›®æ¨™ç›®éŒ„') {
            steps {
                script {
                    // ä½¿ç”¨ rsync åŒæ­¥å°ˆæ¡ˆåˆ°ç›®æ¨™ç›®éŒ„
                    sh "rsync -avz ${RSYNC_SOURCE_FRONTEND_DIR}/ ${RSYNC_TARGET_FRONTEND_DIR}/"
                    sh "rsync -avz ${RSYNC_SOURCE_BACKEND_DIR}/ ${RSYNC_TARGET_BACKEND_DIR}/"
                }
            }
        }

    }

    post {
        always {
            script {
                def buildResult = currentBuild.currentResult
                // åŸ·è¡ŒLINE NOTIFYè…³æœ¬
                sh """
                echo "éƒ¨ç½²ç»“æœ: ${buildResult}"
                sh ${WORKSPACE}/send_line_notify.sh $JOB_NAME $BUILD_NUMBER $BUILD_URL $GIT_BRANCH $GIT_COMMIT $WORKSPACE $LINE_NOTIFY_TOKEN ${buildResult}
                """
                // è®€å–HTMLæ¨¡æ¿å…§å®¹
                def customHtmlTemplate = readFile('custom.html')
                // å¯„é€éƒµä»¶
                emailext (
                    subject: "$JOB_NAME-#$BUILD_NUMBER-${buildResult}",
                    body: customHtmlTemplate,
                    mimeType: 'text/html',
                    to: "markhsu0704@gmail.com"
                )
            }
            script {
                // æ–°å¢å–®å…ƒæ¸¬è©¦å ±å‘Šçµæœçš„å­˜æª”
                archiveArtifacts artifacts: 'allure-results/**', allowEmptyArchive: true
                // æ–°å¢pythonæ‰“åŒ…çµæœçš„å­˜æª”
                archiveArtifacts artifacts: 'dist/**', allowEmptyArchive: true
            }
             // å®‰è£… curl & pandoc
            script {
                sh '''
                if ! command -v curl &> /dev/null; then sudo apt update && sudo apt install -y curl; fi
                if ! command -v pandoc &> /dev/null; then apt update && apt install -y pandoc; fi
                '''
            }
            script {
                // ç§»é™¤ markdown æ–‡ä»¶ä¸­çš„æ¨™é¡Œæ¨™è¨˜
                // ä½¿ç”¨ pandoc å°‡markdownè½‰æ›ç‚ºHTML
                sh '''
                sed -i 's/### //' CHANGELOG.md
                sed -i 's/## //' CHANGELOG.md
                pandoc -f markdown -t html -o changelog.html CHANGELOG.md
                '''

                // è®€å–è‡ªå®šç¾©CSSæ¨£å¼
                def cssContent = readFile('style.css')

                // è®€å–ç”Ÿæˆçš„ HTML æ–‡ä»¶
                def changelogHtml = readFile('changelog.html')


                // åœ¨ HTML æ–‡ä»¶çš„é–‹é ­æ”¾å…¥å±…ä¸­çš„ H1 æ¨™é¡Œ
                changelogHtml = "<style>${cssContent}</style><h1>$JOB_NAME-#$BUILD_NUMBER-Gitç‰ˆæœ¬è®Šæ›´ç´€éŒ„</h1>\n" + changelogHtml

                changelogHtml = "<link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css\">" + changelogHtml


                // å°‡è®Šæ›´æ—¥èªŒä¿å­˜åˆ°æ–‡ä»¶
                writeFile file: 'changelog.html', text: changelogHtml


                // æ­¸æª”HTML
                archiveArtifacts artifacts: 'changelog.html', onlyIfSuccessful: false

                // åœ¨ Jenkins å¢åŠ HTMLé€£æ¥
                publishHTML(target: [
                    allowMissing: false,
                    alwaysLinkToLastBuild: false,
                    keepAll: true,
                    reportDir: '.',
                    reportFiles: 'changelog.html',
                    reportName: 'Gitlabç‰ˆæœ¬è®Šæ›´ç´€éŒ„'
                ])
            }


        }
    }

}
```

#### 1.4.2.3. æ’°å¯«å–®å…ƒæ¸¬è©¦æ‰€éœ€è…³æœ¬

> [!note] å°æç¤º 
> é€™è£¡çš„å–®å…ƒæ¸¬è©¦åªæ˜¯æ¸¬è©¦ï¼Œå¯¦éš›éœ€æ±‚ä¸æœƒé‚£éº¼ç°¡å–®
>1. å¯¦éš›æœƒåšè³‡æ–™åº«é€£ç·šå–®å…ƒæ¸¬è©¦
>2. å…¶ä»–å¯èƒ½éœ€è¦çš„æ¸¬è©¦(æš«æ™‚æƒ³ä¸åˆ°)


```python
def add(a, b):
    return a + b
```


```python
from math_operations import add

def test_add():
    assert add(1, 2) == 3
    assert add(-1, 1) == 0
    assert add(-1, -1) == -2
```


### 1.4.3. éƒ¨ç½²å¾Œæµç¨‹æ‰€éœ€è…³æœ¬

#### 1.4.3.1. æ’°å¯«LINE NOTIFYéƒ¨ç½²å¾Œé€šçŸ¥è…³æœ¬


```bash
#!/bin/bash
#+-------------------------------------è…³æœ¬èªªæ˜--------------------------------------------+
# MARKWEB_SERVERéƒ¨ç½²çµæœè¨Šæ¯å‚³é€
# ä½¿ç”¨æ–¹å¼: ./send_line_notify.sh
#
# (C) 2023 - markhsu - licensed under markweb License v1.
#
#+----------------------------------------------------------------------------------------+

#+----------------------------------------------------------------------------------------+
#                                     å¢åŠ LINE NOTIFYé€šçŸ¥
#+----------------------------------------------------------------------------------------+
apt update && apt install curl -y

# å¾Jenkinsåƒæ•¸å–å¾—è¨Šæ¯

MESSAGE="é …ç›®åç¨±:$1
éƒ¨ç½²ç‰ˆè™Ÿ:$2
éƒ¨ç½²æ—¥èªŒ:$3
éƒ¨ç½²çµæœ:$8
éƒ¨ç½²åˆ†æ”¯:$4
æäº¤è­˜åˆ¥ç¢¼:$5
å·¥ä½œç›®éŒ„:$6
"

# DEBUG è¨Šæ¯
echo "é …ç›®åç¨±:$1"
echo "éƒ¨ç½²ç‰ˆè™Ÿ:$2"
echo "éƒ¨ç½²æ—¥èªŒ:$3"
echo "éƒ¨ç½²çµæœ:$8"
echo "éƒ¨ç½²åˆ†æ”¯:$4"
echo "æäº¤è­˜åˆ¥ç¢¼:$5"
echo "å·¥ä½œç›®éŒ„:$6"

# å‘¼å«Line notify API
curl -X POST -H "Authorization: Bearer $7" \
    -F "message=$MESSAGE" \
    https://notify-api.line.me/api/notify
```

#### 1.4.3.2. æ’°å¯«éƒµä»¶é€šçŸ¥æ¨¡æ¿

```html
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>${ENV, var="JOB_NAME"}-ç¬¬${BUILD_NUMBER}æ¬¡ä½ˆç½²æ—¥èªŒ</title>
<style>
.post_body{
    border-bottom: 2px dashed #ccc;
    border: 2px dashed #202124;
    padding: 15px;
    margin-bottom: 20px;
    border-left: 3px solid #202124;
}
textarea{
border: 2px dashed #202124;
}
</style>
</head>
<body leftmargin="8" marginwidth="0" topmargin="8" marginheight="4"
    offset="0">
    <table width="95%" cellpadding="0" cellspacing="0"
        style="font-size: 11pt; font-family: Tahoma, Arial, Helvetica, sans-serif">
        <tr>
            <td>
                <h2>
                    <font>ä»¥ä¸‹æ¥è‡ªMarkWeb.Jenkinsçš„éƒµä»¶é€šçŸ¥</font>
                </h2>
            </td>
        </tr>
        <tr>
            <td class='post_body'>
                <b><font color="#0B610B">ä½ˆç½²è¨Šæ¯</font></b>
             </td>
        </tr>
        <tr>
            <td>
                <ul>
                    <li>é …ç›®åç¨±&nbsp;ï¼š&nbsp;${PROJECT_NAME}</li>
                    <li>ä½ˆç½²ç‰ˆè™Ÿ&nbsp;ï¼š&nbsp;${BUILD_NUMBER}</li>
                    <li>ä½ˆç½²çµæœ&nbsp;ï¼š&nbsp;${BUILD_STATUS}</li>
                    <li>ä½ˆç½²æ—¥èªŒ&nbsp;ï¼š&nbsp;<a href="${BUILD_URL}console">${BUILD_URL}console</a></li>
                    <li>è§¸ç™¼åŸå› &nbsp;ï¼š${CAUSE}</li>
                    <li>å–®å…ƒæ¸¬è©¦å ±å‘Š&nbsp;ï¼š<a href="${BUILD_URL}testReport/">${BUILD_URL}testReport/</a></li>
                    <li>å·¥ä½œç›®éŒ„&nbsp;ï¼š&nbsp;<a href="${PROJECT_URL}ws">${PROJECT_URL}lastSuccessfulBuild/artifact/</a></li>
                </ul>
            </td>
        </tr>
        <tr>
            <td class='post_body'><b><font color="#0B610B">ä½ˆç½²æ—¥èªŒ:</font></b>
        </tr>
        <br />
        <br />
        <tr>
            <td>
            <textarea cols="120" rows="30" readonly="readonly" style="font-family: Courier New">${BUILD_LOG}</textarea>
            </td>
        </tr>
    </table>
</body>
</html>
```

## 1.5. å•é¡Œè™•ç†

> [!warning] å°æç¤º 
> 1.  ALLUREç’°å¢ƒè®Šæ•¸æ‰¾ä¸åˆ°çš„å•é¡Œ?
> (a) è«‹æª¢æŸ¥Jenkinsçš„ALLURE_HOMEç’°å¢ƒè®Šæ•¸æ˜¯å¦è¨­å®šæ­£ç¢º
> (b) é»æ“ŠAllure Commandlineï¼Œè¼¸å…¥åç¨±ä»¥åŠå®‰è£ç›®éŒ„(é€™è£¡ä¸è¦è¨­å®šåˆ°bin)
> 2. ä¸‹è¼‰é€£çµè«‹åƒè€ƒé€™è£¡
> https://github.com/allure-framework/allure2
> 3. ç›®å‰Allureçš„æ–°ç‰ˆæœ¬å·²ä¸æ”¯æ´ç”¢ç”ŸXMLï¼Œæ‰€ä»¥åœ¨Jenkinsçš„pipelineä¸è¦åŠ ä¸Šjunitåƒæ•¸(é€™åƒæ•¸åªæ”¯æ´ç”¢ç”ŸXMLï¼Œä½†æ–°ç‰ˆæœ¬å–®å…ƒæ¸¬è©¦ç´€éŒ„éƒ½æ˜¯jsonæ ¼å¼)

![](https://mybookstack.zeabur.app/uploads/images/gallery/2025-08/7f17b43d-202407271937035.png)

![](https://mybookstack.zeabur.app/uploads/images/gallery/2025-08/8930d02c-202407271938026.png)


## 1.6. å®Œæˆç•«é¢

![](https://mybookstack.zeabur.app/uploads/images/gallery/2025-08/7Rj2fb771e1-202407272001631.png)

![](https://mybookstack.zeabur.app/uploads/images/gallery/2025-08/9778c577-202407271929278.png)

![](https://mybookstack.zeabur.app/uploads/images/gallery/2025-08/LyDc1172715-202407271930465.png)

![](https://mybookstack.zeabur.app/uploads/images/gallery/2025-08/eez07daa084-202407271930714.png)

![](https://mybookstack.zeabur.app/uploads/images/gallery/2025-08/Lf3819489fc-202407271930757.png)

![](https://mybookstack.zeabur.app/uploads/images/gallery/2025-08/YH52a11aef0-202407271932444.png)
