---
title: äººå·¥æ™ºæ…§å·¥ä½œåŠ-å¨›æ¨‚æ–°èåŠ©æ‰‹-å¯¦ä½œæµç¨‹
created: 2024-10-17 09:00:00Z
updated: 2024-10-20 13:07:05Z
tags:
  - AI
  - äººå·¥æ™ºæ…§
  - dify
---
# 1. ã€è‡ªå‹•åŒ–çˆ¬èŸ²ã€‘äººå·¥æ™ºæ…§å·¥ä½œåŠ-å¨›æ¨‚æ–°èåŠ©æ‰‹-å¯¦ä½œæµç¨‹

## 1.1. ç°¡ä»‹

å¦‚ä½•å°‡çˆ¬èŸ²çš„è³‡æ–™å»ºç«‹æˆçŸ¥è­˜åº«ä¸¦ä¸²æ¥`LLMæ¨¡å‹`æœ€å¾Œéƒ¨ç½²åˆ°`LINEBOT`

## 1.2. ç›®éŒ„

- [1. ã€è‡ªå‹•åŒ–çˆ¬èŸ²ã€‘äººå·¥æ™ºæ…§å·¥ä½œåŠ-å¨›æ¨‚æ–°èåŠ©æ‰‹-å¯¦ä½œæµç¨‹](#1-è‡ªå‹•åŒ–çˆ¬èŸ²äººå·¥æ™ºæ…§å·¥ä½œåŠ-å¨›æ¨‚æ–°èåŠ©æ‰‹-å¯¦ä½œæµç¨‹)
  - [1.1. ç°¡ä»‹](#11-ç°¡ä»‹)
  - [1.2. ç›®éŒ„](#12-ç›®éŒ„)
  - [1.3. æ“ä½œæ­¥é©Ÿ](#13-æ“ä½œæ­¥é©Ÿ)
    - [1.3.1. ä½¿ç”¨dockerå®‰è£dify](#131-ä½¿ç”¨dockerå®‰è£dify)
    - [1.3.2. difyåŸºç¤é…ç½®èˆ‡è¨­å®š](#132-difyåŸºç¤é…ç½®èˆ‡è¨­å®š)
      - [1.3.2.1. è¨­å®š`dify`ç®¡ç†å“¡å¸³è™Ÿ](#1321-è¨­å®šdifyç®¡ç†å“¡å¸³è™Ÿ)
      - [1.3.2.2. è¨­å®š`dify`èªè¨€èˆ‡æ™‚å€](#1322-è¨­å®šdifyèªè¨€èˆ‡æ™‚å€)
      - [1.3.2.3. è¨­å®š`æ¨¡å‹ä¾›æ‡‰å•†`](#1323-è¨­å®šæ¨¡å‹ä¾›æ‡‰å•†)
    - [1.3.3. å»ºç«‹`dify`æ–°èå°åŠ©æ‰‹æ‡‰ç”¨](#133-å»ºç«‹difyæ–°èå°åŠ©æ‰‹æ‡‰ç”¨)
      - [1.3.3.1. å»ºç«‹ç©ºç™½æ‡‰ç”¨\&ç›¸é—œè¨­å®š](#1331-å»ºç«‹ç©ºç™½æ‡‰ç”¨ç›¸é—œè¨­å®š)
    - [1.3.4. pythonçˆ¬èŸ²ç¨‹å¼æ’°å¯«\&difyçŸ¥è­˜åº«APIä¸²æ¥](#134-pythonçˆ¬èŸ²ç¨‹å¼æ’°å¯«difyçŸ¥è­˜åº«apiä¸²æ¥)
      - [1.3.4.1. yahooå¥‡æ‘©å¨›æ¨‚æ–°èçˆ¬èŸ²ç¨‹å¼ç¢¼](#1341-yahooå¥‡æ‘©å¨›æ¨‚æ–°èçˆ¬èŸ²ç¨‹å¼ç¢¼)
      - [1.3.4.2. difyçŸ¥è­˜åº«APIä¸²æ¥ç¯„ä¾‹](#1342-difyçŸ¥è­˜åº«apiä¸²æ¥ç¯„ä¾‹)
    - [1.3.5. `LINEBOT`èˆ‡`difyçŸ¥è­˜åº«`é€²è¡Œä¸²æ¥](#135-linebotèˆ‡difyçŸ¥è­˜åº«é€²è¡Œä¸²æ¥)
      - [1.3.5.1. `LINEBOT`èˆ‡\`difyåƒæ•¸è¨­å®š](#1351-linebotèˆ‡difyåƒæ•¸è¨­å®š)
      - [1.3.5.2. LINEBOT WEBHOOK CALLBACKç¨‹å¼](#1352-linebot-webhook-callbackç¨‹å¼)
      - [1.3.5.3. LINEBOT ç›¸é—œäº‹ä»¶é‚è¼¯è™•ç†](#1353-linebot-ç›¸é—œäº‹ä»¶é‚è¼¯è™•ç†)
      - [1.3.5.4. LINEBOT ä¸»ç¨‹å¼é‚è¼¯è™•ç†(è² è²¬æ¥æ”¶ä½¿ç”¨å‚³ééä¾†çš„è¨Šæ¯èˆ‡å›æ‡‰)](#1354-linebot-ä¸»ç¨‹å¼é‚è¼¯è™•ç†è² è²¬æ¥æ”¶ä½¿ç”¨å‚³ééä¾†çš„è¨Šæ¯èˆ‡å›æ‡‰)
      - [1.3.5.5. ä½¿ç”¨`python flask`å•Ÿå‹•`server`](#1355-ä½¿ç”¨python-flaskå•Ÿå‹•server)
    - [1.3.6. éƒ¨ç½²`LINEBOT`åˆ°`docker`](#136-éƒ¨ç½²linebotåˆ°docker)
      - [1.3.6.1. æ’°å¯«dockerfile](#1361-æ’°å¯«dockerfile)
      - [1.3.6.2. æ’°å¯«docker-compose.yml](#1362-æ’°å¯«docker-composeyml)
      - [1.3.6.3. éƒ¨ç½²åˆ°docker](#1363-éƒ¨ç½²åˆ°docker)
    - [1.3.7. éƒ¨ç½² Stable Diffusion WebUIåˆ°`docker`](#137-éƒ¨ç½²-stable-diffusion-webuiåˆ°docker)
    - [1.3.8. Stable Diffusion WebUIåŸºç¤è¨­å®š](#138-stable-diffusion-webuiåŸºç¤è¨­å®š)
    - [1.3.9. Stable Diffusion è‡ªå®šç¾©APIä¸²æ¥](#139-stable-diffusion-è‡ªå®šç¾©apiä¸²æ¥)
      - [1.3.9.1. æ’°å¯«dockerfile](#1391-æ’°å¯«dockerfile)
      - [1.3.9.2. æ’°å¯«docker-compose.yml](#1392-æ’°å¯«docker-composeyml)
      - [1.3.9.3. æ’°å¯«app.py](#1393-æ’°å¯«apppy)
    - [1.3.10. difyå·¥ä½œæµå»ºç«‹](#1310-difyå·¥ä½œæµå»ºç«‹)
      - [1.3.10.1. å•é¡Œåˆ†é¡](#13101-å•é¡Œåˆ†é¡)
      - [1.3.10.2. çŸ¥è­˜åº«å»ºç«‹](#13102-çŸ¥è­˜åº«å»ºç«‹)
      - [1.3.10.3. åˆ¤æ–·æå•ç›¸é—œæ€§-LLM](#13103-åˆ¤æ–·æå•ç›¸é—œæ€§-llm)
      - [1.3.10.4. JSON Parse](#13104-json-parse)
      - [1.3.10.5. æ¢ä»¶åˆ¤æ–·](#13105-æ¢ä»¶åˆ¤æ–·)
      - [1.3.10.6. GoogleSearch](#13106-googlesearch)
      - [1.3.10.7. Jsonæ ¼å¼è½‰å­—ä¸²ç¨‹å¼ç¢¼](#13107-jsonæ ¼å¼è½‰å­—ä¸²ç¨‹å¼ç¢¼)
      - [1.3.10.8. æ ¹æ“šgoogleå›è¦†-LLM](#13108-æ ¹æ“šgoogleå›è¦†-llm)
      - [1.3.10.9. GOOGLESEARCHå•é¡Œå›è¦†](#13109-googlesearchå•é¡Œå›è¦†)
      - [1.3.10.10. æ ¹æ“šçŸ¥è­˜åº«å›è¦†-LLM](#131010-æ ¹æ“šçŸ¥è­˜åº«å›è¦†-llm)
      - [1.3.10.11. çŸ¥è­˜åº«å•é¡Œå›è¦†](#131011-çŸ¥è­˜åº«å•é¡Œå›è¦†)
      - [1.3.10.12. å»ºç«‹è‡ªå®šç¾©å°å·¥å…·](#131012-å»ºç«‹è‡ªå®šç¾©å°å·¥å…·)
      - [1.3.10.13. è‡ªå®šç¾©å°å·¥å…·æµç¨‹è¨­å®š](#131013-è‡ªå®šç¾©å°å·¥å…·æµç¨‹è¨­å®š)
      - [1.3.10.14. åˆ¤æ–·æ¢ä»¶è¨­å®š](#131014-åˆ¤æ–·æ¢ä»¶è¨­å®š)
      - [1.3.10.15. åœ–æª”èªæ³•è½‰æ›](#131015-åœ–æª”èªæ³•è½‰æ›)
      - [1.3.10.16. difyåœ–æª”å‘ˆç¾çµæœ](#131016-difyåœ–æª”å‘ˆç¾çµæœ)
      - [1.3.10.17. LINEBOTåœ–æª”å‘ˆç¾çµæœ](#131017-linebotåœ–æª”å‘ˆç¾çµæœ)
    - [1.3.11. LINEBOTåœ–æª”å›å‚³é‚è¼¯æ’°å¯«](#1311-linebotåœ–æª”å›å‚³é‚è¼¯æ’°å¯«)
    - [1.3.12. æ¸¬è©¦çµæœ](#1312-æ¸¬è©¦çµæœ)

## 1.3. æ“ä½œæ­¥é©Ÿ

### 1.3.1. ä½¿ç”¨dockerå®‰è£dify

git cloneæŒ‡ä»¤ï¼Œå°‡ Dify è¤‡è£½åˆ°ä½ çš„è£ç½®ä¸­

```bash
git clone https://github.com/langgenius/dify.git
```

é€²åˆ°Â `dify/docker`Â ä¸­ï¼Œé€™é‚Šæ”¾äº†æ‰€æœ‰å’Œ docker æœ‰é—œçš„è¨­å®š

![](https://markweb.idv.tw/uploads/202410131919941.png)


å»ºç«‹ç’°å¢ƒæª”æ¡ˆ (`.env`) é€™é‚Šç›´æ¥è¤‡è£½ä»–çš„ç¯„ä¾‹å³å¯ï¼Œä¸¦ä¿®æ”¹ç´…æ¡†è™•çš„åƒæ•¸

![](https://markweb.idv.tw/uploads/202410131922329.png)

é€™é‚Š Dify æœ‰ nginx çš„ containerï¼Œæœƒå°‡æœå‹™é–‹åœ¨æˆ‘å€‘é›»è…¦çš„ 80 port å’Œ 443 port (å¦‚æœæœ‰å•Ÿå‹• https)ï¼Œå¦‚æœä½ ä¸æƒ³é–‹åœ¨é€™äº› port æˆ–è€…é›»è…¦é€™äº› port å·²ç¶“è¢«ä½¿ç”¨äº†å¯ä»¥è‡ªè¡Œä¿®æ”¹Â `.env`

![](https://markweb.idv.tw/uploads/202410131923361.png)

å•Ÿå‹• docker compose

```bash
docker compose up -d # é€™é‚Šçš„ -d æ˜¯èƒŒæ™¯åŸ·è¡Œçš„æ„æ€
```


å¯ä»¥åœ¨windowså®‰è£`docker desktop`ï¼Œæª¢æŸ¥é€™äº›å®¹å™¨æ˜¯å¦æœ‰`æ­£å¸¸é‹è¡Œ`

![](https://markweb.idv.tw/uploads/202410131926785.png)


<!--more-->

### 1.3.2. difyåŸºç¤é…ç½®èˆ‡è¨­å®š
#### 1.3.2.1. è¨­å®š`dify`ç®¡ç†å“¡å¸³è™Ÿ

å®‰è£å®Œæˆå¾Œï¼Œè«‹å…ˆé€²å…¥difyä¸»ç•«é¢
```
http://localhost:[ports]/install
```

#### 1.3.2.2. è¨­å®š`dify`èªè¨€èˆ‡æ™‚å€

åˆ°å³ä¸Šè§’é»æ“Šé ­åƒ->è¨­å®š -> èªè¨€

![](https://markweb.idv.tw/uploads/202410131933305.png)


#### 1.3.2.3. è¨­å®š`æ¨¡å‹ä¾›æ‡‰å•†`

åˆ°å³ä¸Šè§’é»æ“Šé ­åƒ->è¨­å®š -> æ¨¡å‹ä¾›æ‡‰å•†

é€™é‚Šæœƒçœ‹åˆ° Dify æœ‰æ”¯æ´çš„æ‰€æœ‰ LLM API (è¶…ç´šå¤š...)ï¼ŒåŒ…å«æœƒç”¨åˆ°çš„ OpenAI,gemini, å’Œæœ¬åœ°çš„ Ollama ç­‰ç­‰ï¼ŒæŒ‰ä¸‹è¨­å®šç„¶å¾Œè¼¸å…¥ `API Key` å³å¯ä½¿ç”¨ï¼Œå®Œæˆå¾Œå¦‚ä¸‹åœ–

![](https://markweb.idv.tw/uploads/202410131938562.png)


### 1.3.3. å»ºç«‹`dify`æ–°èå°åŠ©æ‰‹æ‡‰ç”¨

#### 1.3.3.1. å»ºç«‹ç©ºç™½æ‡‰ç”¨&ç›¸é—œè¨­å®š

åˆ°æœ€ä¸Šæ–¹é»æ“Šå·¥ä½œå®¤->å»ºç«‹ç©ºç™½æ‡‰ç”¨ -> é¸æ“‡èŠå¤©åŠ©æ‰‹->åŸºç¤ç·¨æ’->`åç¨±`å¯ä»¥`ä»»æ„å–`->é»æ“Šå»ºç«‹

![](https://markweb.idv.tw/uploads/202410131940094.png)


 æç¤ºè©é…ç½®(å¯ä»¥chatgptå”åŠ©ç”Ÿæˆ)

```
è‹¥æœ‰äººè©¢å•ä½ æ˜¯èª°æˆ–æ˜¯è¦ªåˆ‡çš„å•å€™æ™‚ï¼Œè«‹å›è¦†ï¼š

ã€Œæ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„äººå·¥æ™ºæ…§æ–°èåŠ©æ‰‹ï¼Œå¾ˆé«˜èˆˆèƒ½ç‚ºæ‚¨æä¾›å¹«åŠ©ã€‚ã€

è«‹æ ¹æ“šä½¿ç”¨è€…è¼¸å…¥çš„ã€é—œéµå­—ã€‘åœ¨çŸ¥è­˜åº«ä¸­æœå°‹ç›¸é—œæ–°èï¼Œä¸¦æŒ‰ç…§ä»¥ä¸‹æ ¼å¼æ•´ç†è¼¸å‡ºï¼š

å›è¦†æ ¼å¼ï¼š

æ ¹æ“šæˆ‘çš„æœå°‹çµæœï¼Œæˆ‘æ‰¾åˆ°äº†ä»¥ä¸‹çš„æ–°èï¼š

æ–°èæ¨™é¡Œï¼š

ã€æ¨™é¡Œ1ã€‘

æ–°èæ‘˜è¦ï¼š

ã€æ‘˜è¦1ã€‘

æ–°èæ—¥æœŸï¼š

ã€æ—¥æœŸ1ã€‘

æ–°èä¾†æºï¼š

ã€ä¾†æº1ã€‘

å®Œæ•´å…§å®¹é€£çµï¼š

é€£çµ1

ï¼ˆä¾æ­¤æ ¼å¼ç¹¼çºŒåˆ—å‡ºæœ€å¤š 5 å‰‡æ–°èï¼‰

ğŸ“Œ æ³¨æ„äº‹é …ï¼š

åˆ—å‡ºæœ€å¤š 5 å‰‡æ–°èï¼Œä¸¦æŒ‰ç…§æ—¥æœŸç”±è¿‘è‡³é çš„é †åºæ’åºã€‚

è‹¥æ–°èæ¨™é¡Œæˆ–æ‘˜è¦å…§å®¹éæ–¼ç›¸ä¼¼ï¼Œåƒ…é¡¯ç¤ºå…¶ä¸­ä¸€å‰‡ï¼Œä¸¦ç”¨å…¶ä»–ä¸é‡è¤‡çš„æ–°èæ›¿æ›ã€‚
```


é¸æ“‡å¼•ç”¨çŸ¥è­˜åº«

![](https://markweb.idv.tw/uploads/202410131952045.png)


é€™è£¡å¯ä»¥è‡ªå·±æ¸¬è©¦ä¸¦é¸æ“‡é©ç•¶çš„æ¨¡å‹

![](https://markweb.idv.tw/uploads/202410131954599.png)


æ¯æ¬¡é…ç½®å®Œä¹‹å¾Œï¼Œéƒ½è¦é¸æ“‡`ç™¼ä½ˆ->æ›´æ–°`æ‰æœƒç”Ÿæ•ˆå–”

![](https://markweb.idv.tw/uploads/202410131955698.png)


### 1.3.4. pythonçˆ¬èŸ²ç¨‹å¼æ’°å¯«&difyçŸ¥è­˜åº«APIä¸²æ¥

#### 1.3.4.1. yahooå¥‡æ‘©å¨›æ¨‚æ–°èçˆ¬èŸ²ç¨‹å¼ç¢¼

é€™é‚Šä»¥yahooå¥‡æ‘©å¨›æ¨‚æ–°èç‚ºä¸»ï¼Œå¯è‡ªè¡Œèª¿æ•´æ’°å¯«ï¼Œä¸»è¦çˆ¬èŸ²ç‰‡æ®µå¦‚ä¸‹

```python
from selenium import webdriver  
from selenium.webdriver.common.by import By  
from selenium.webdriver.common.keys import Keys  
from selenium.webdriver.chrome.service import Service  
from selenium.webdriver.support.ui import WebDriverWait  
from selenium.webdriver.support import expected_conditions as EC  
from selenium.webdriver.chrome.options import Options  
from webdriver_manager.chrome import ChromeDriverManager  
import time  
import csv  
import dateparser  
import requests  
import json  
from setting import ENV_URL, CSV_FILENAME, API_ENDPOINT, DATASET_ID, DOCUMENT_ID, DOCUMENT_API_KEY, DIFY_API_KEY,TXT_FILENAME,JSON_FILENAME  
import os  
  
# è¨­å®š Chrome ç€è¦½å™¨é¸é …  
chrome_options = Options()  
chrome_options.add_argument("--headless")  # ç„¡é ­æ¨¡å¼  
chrome_options.add_argument("--no-sandbox")  # é¿å…æ²™ç›’å•é¡Œ  
chrome_options.add_argument("--disable-dev-shm-usage")  # è§£æ±ºè³‡æºé™åˆ¶å•é¡Œ  
chrome_options.add_argument("--disable-gpu")  # ç¦ç”¨ GPU åŠ é€Ÿ  
chrome_options.add_argument("--window-size=1920x1080")  # è¨­å®šçª—å£å¤§å°  
  
  
# åˆå§‹åŒ– driver è®Šæ•¸  
driver = None  
  
# è¨­å®šæ‘˜è¦æœ€å¤§é•·åº¦  
MAX_SUMMARY_LENGTH = 100  # ä½ å¯ä»¥æ ¹æ“šéœ€è¦ä¿®æ”¹é€™å€‹é•·åº¦  
  
try:  
    # ä½¿ç”¨ WebDriverManager è‡ªå‹•ç²å– ChromeDriver    driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=chrome_options)  
    # Yahoo å°ç£å¨›æ¨‚æ–°èçš„ URL    url = ENV_URL  
  
    # æ‰“é–‹ç¶²é   
    driver.get(url)  
  
    # æ»¾å‹•é é¢è‡³å°‘äº”æ¬¡  
    scroll_times = 5  
    for _ in range(scroll_times):  
        driver.find_element(By.TAG_NAME, 'body').send_keys(Keys.END)  
        time.sleep(1)  # ç­‰å¾…é é¢è¼‰å…¥  
  
    # é¡¯æ€§ç­‰å¾…ï¼Œç¢ºä¿å…§å®¹è¼‰å…¥  
    wait = WebDriverWait(driver, 2)  
  
    # æ‰¾åˆ°æ‰€æœ‰ç›®æ¨™å€å¡Š (æ ¹æ“š class åç¨±)  
    items = wait.until(EC.presence_of_all_elements_located((By.CLASS_NAME, 'StreamMegaItem')))  
  
    # æª¢æŸ¥æ˜¯å¦æœ‰ç¾å­˜çš„ CSV æª”æ¡ˆï¼Œè®€å–å…¶å…§å®¹ä¸¦å„²å­˜ç¾æœ‰çš„æ¨™é¡Œ  
    existing_rows = set()  
    if os.path.exists(CSV_FILENAME):  
        with open(CSV_FILENAME, 'r', encoding='utf-8-sig') as csvfile:  
            reader = csv.DictReader(csvfile)  
            for row in reader:  
                key = (row['Title'], row['Source_Summary'], row['Time'])  
                existing_rows.add(key)  
  
    # å„²å­˜è¦åŒ¯å‡ºæˆ JSON å’Œ TXT çš„è³‡æ–™åˆ—è¡¨  
    json_data = []  
    txt_content = ""  
  
    # é–‹å•Ÿ CSV æª”æ¡ˆä»¥ä¾›å¯«å…¥ (è¦†è“‹æˆ–æ–°å¢)  
    with open(CSV_FILENAME, 'w', newline='', encoding='utf-8-sig') as csvfile:  
        # å®šç¾©æ¬„ä½åç¨±  
        fieldnames = ['Title', 'Summary', 'Article_URL', 'Source_Summary', 'Time']  
        writer = csv.DictWriter(csvfile, fieldnames=fieldnames)  
  
        # å¯«å…¥æ¨™é¡Œåˆ—  
        writer.writeheader()  
  
        # éæ­·æ¯å€‹å€å¡Šï¼Œæå–æ‰€éœ€è³‡è¨Š  
        for item in items:  
            try:  
                title = item.find_element(By.CSS_SELECTOR, 'h3').text.strip()  
            except:  
                title = 'N/A'  
  
            try:  
                summary = item.find_element(By.CSS_SELECTOR, 'p').text.strip()  
                if len(summary) > MAX_SUMMARY_LENGTH:  
                    summary = summary[:MAX_SUMMARY_LENGTH] + '...'  
                summary = summary.replace('\n', '\n\n')  
            except:  
                summary = 'N/A'  
  
            try:  
                article_url = item.find_element(By.CLASS_NAME, 'mega-item-header-link').get_attribute('href')  
            except:  
                article_url = 'N/A'  
  
            try:  
                time_info = item.find_element(By.XPATH, ".//div[contains(@class, 'C(#959595)')]").text.strip()  
                source, time_posted_relative = time_info.split(' â€¢ ')  
                time_posted = dateparser.parse(time_posted_relative)  
                time_posted = time_posted.strftime('%Y-%m-%d %H:%M:%S') if time_posted else 'N/A'  
            except:  
                source, time_posted = 'N/A', 'N/A'  
  
            # æª¢æŸ¥æ˜¯å¦é‡è¤‡ï¼ˆTitle, Source_Summary, Timeï¼‰  
            data_key = (title, source, time_posted)  
            if data_key in existing_rows:  
                print(f"é‡è¤‡è³‡æ–™ï¼Œè·³é: {data_key}")  
                continue  # è·³éé‡è¤‡è³‡æ–™  
  
            row_data = {  
                'Title': title,  
                'Summary': summary,  
                'Article_URL': article_url,  
                'Source_Summary': source,  
                'Time': time_posted  
            }  
  
            writer.writerow(row_data)  
            json_data.append(row_data)  
            txt_content += f"æ¨™é¡Œ: {title}\nå…§æ–‡æ‘˜è¦: {summary}\næ–‡ç« ç¶²å€: {article_url}\nä¾†æºæ‘˜è¦: {source}\næ™‚é–“: {time_posted}\n{'-' * 30}\n"  
  
            # è¼¸å‡ºå–å¾—çš„è³‡è¨Š  
            print(f'æ¨™é¡Œ: {title}')  
            print(f'å…§æ–‡æ‘˜è¦: {summary}')  
            print(f'æ–‡ç« ç¶²å€: {article_url}')  
            print(f'ä¾†æºæ‘˜è¦: {source}')  
            print(f'æ™‚é–“: {time_posted}')  
            print('-' * 30)  
  
    # å°‡è³‡æ–™åŒ¯å‡ºç‚º JSON æª”æ¡ˆ  
    with open(JSON_FILENAME, 'w', encoding='utf-8') as jsonfile:  
        json.dump(json_data, jsonfile, ensure_ascii=False, indent=4)  
  
    # å°‡è³‡æ–™åŒ¯å‡ºç‚º TXT æª”æ¡ˆ  
    with open(TXT_FILENAME, 'w', encoding='utf-8') as txtfile:  
        txtfile.write(txt_content)  
  
except Exception as e:  
    print("An error occurred:", e)  
  
finally:  
    if driver:  
        driver.quit()
```

#### 1.3.4.2. difyçŸ¥è­˜åº«APIä¸²æ¥ç¯„ä¾‹


æª¢æŸ¥è³‡æ–™é›†æ˜¯å¦å­˜åœ¨
```python

def check_dataset_exists(dataset_id, api_key):  
    api_endpoint = API_ENDPOINT + "/v1/datasets?page=1&limit=20"  
  
    headers = {  
        'Authorization': f'Bearer {api_key}'  
    }  
  
    response = requests.get(api_endpoint, headers=headers)  
  
    if response.status_code == 200:  
        datasets = response.json().get('data', [])  
        # æª¢æŸ¥æŒ‡å®šçš„ dataset_id æ˜¯å¦å­˜åœ¨æ–¼è³‡æ–™é›†ä¸­  
        for dataset in datasets:  
            if dataset['id'] == dataset_id:  
                return True  
        return False    else:  
        print(f'ç„¡æ³•ç²å–è³‡æ–™é›†åˆ—è¡¨ï¼Œç‹€æ…‹ç¢¼: {response.status_code}, å›æ‡‰: {response.text}')  
        return False

```

æª¢æŸ¥è³‡æ–™é›†ç•¶ä¸­æ–‡ä»¶æ˜¯å¦å­˜åœ¨

```python

def check_document_exists(dataset_id, document_id, api_key):  
    # å®šç¾©åˆ—å‡ºè³‡æ–™é›†ä¸­æ‰€æœ‰æ–‡ä»¶çš„ API ç«¯é»  
    api_endpoint = f"{API_ENDPOINT}/v1/datasets/{dataset_id}/documents"  
    headers = {  
        'Authorization': f'Bearer {api_key}'  
    }  
  
    response = requests.get(api_endpoint, headers=headers)  
  
    if response.status_code == 200:  
        documents = response.json().get('data', [])  
        # æª¢æŸ¥æ–‡ä»¶ ID æ˜¯å¦åœ¨æ–‡ä»¶åˆ—è¡¨ä¸­  
        for document in documents:  
            if document.get('id') == document_id:  
                return True  # æ‰¾åˆ°å°æ‡‰çš„æ–‡ä»¶ IDï¼Œå›å‚³ True        return False  # æ²’æœ‰æ‰¾åˆ°å°æ‡‰çš„æ–‡ä»¶ IDï¼Œå›å‚³ False    else:  
        print(f'æª¢æŸ¥æ–‡ä»¶å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: {response.status_code}, å›æ‡‰: {response.text}')  
        return False
```

æ›´æ–°å·²å­˜åœ¨çš„çŸ¥è­˜åº«
```python

def update_existing_document(file_path, dataset_id, document_id, api_key):  
    # å®šç¾©æ›´æ–°æ–‡ä»¶çš„ API ç«¯é»  
    api_endpoint = f"{API_ENDPOINT}/v1/datasets/{dataset_id}/documents/{document_id}/update_by_file"  
  
    # å®šç¾©è«‹æ±‚æ¨™é ­  
    headers = {  
        'Authorization': f'Bearer {api_key}'  
    }  
  
    # å®šç¾©è¡¨å–®è³‡æ–™ï¼ˆå°‡è³‡æ–™è½‰ç‚º JSONï¼‰  
    data = {  
        'data': json.dumps({  
            "name": "Dify",  
            "indexing_technique": "high_quality",  
            "process_rule": {  
                "rules": {  
                    "pre_processing_rules": [  
                        {"id": "remove_extra_spaces", "enabled": True},  
                        {"id": "remove_urls_emails", "enabled": False}  
                    ],                    "segmentation": {  
                        "separator": "------------------------------",  
                        "max_tokens": 1000  
                    }  
                },                "mode": "custom"  
            }  
        })    }  
    # è¨­å®šæª”æ¡ˆ  
    files = {  
        'file': open(file_path, 'rb')  
    }  
    # ç™¼é€ POST è«‹æ±‚æ›´æ–°æ–‡ä»¶  
    response = requests.post(api_endpoint, headers=headers, data=data, files=files)  
  
    # æª¢æŸ¥å›æ‡‰  
    if response.status_code == 200:  
        print('æ–‡ä»¶æˆåŠŸæ›´æ–°è‡³ Dify')  
    else:  
        print(f'æ›´æ–°å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: {response.status_code}, å›æ‡‰: {response.text}')

```

ä¸Šå‚³çŸ¥è­˜åº«
```python
def upload_to_dify(file_path, dataset_id, document_id, api_key):  
    # æª¢æŸ¥è³‡æ–™é›†æ˜¯å¦å­˜åœ¨  
    if not check_dataset_exists(dataset_id, api_key):  
        print(f'è³‡æ–™é›† {dataset_id} ä¸å­˜åœ¨')  
        return  
  
    # æª¢æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨  
    if check_document_exists(dataset_id, document_id, api_key):  
        print(f'æ–‡ä»¶ {document_id} å·²å­˜åœ¨æ–¼è³‡æ–™é›† {dataset_id}ï¼Œå°‡æ›´æ–°è©²æ–‡ä»¶ã€‚')  
        # æ›´æ–°ç¾æœ‰æ–‡ä»¶  
        update_existing_document(file_path, dataset_id, document_id, api_key)  
    else:  
        print('æ–‡ä»¶ä¸å­˜åœ¨ï¼Œé€²è¡Œä¸Šå‚³ã€‚')  
        # æ–‡ä»¶ä¸å­˜åœ¨ï¼Œé€²è¡Œä¸Šå‚³  
        api_endpoint = f"{API_ENDPOINT}/v1/datasets/{dataset_id}/document/create_by_file"  
  
        # å®šç¾©è«‹æ±‚æ¨™é ­  
        headers = {  
            'Authorization': f'Bearer {api_key}'  
        }  
  
        # å®šç¾©è¡¨å–®è³‡æ–™  
        data = {  
            'data': json.dumps({  
                "indexing_technique": "high_quality",  
                "process_rule": {  
                    "rules": {  
                        "pre_processing_rules": [  
                            {"id": "remove_extra_spaces", "enabled": True},  
                            {"id": "remove_urls_emails", "enabled": False}  
                        ],                        "segmentation": {  
                            "separator": "------------------------------",  
                            "max_tokens": 1000  
                        }  
                    },                    "mode": "custom"  
                }  
            })        }  
        # è¨­å®šæª”æ¡ˆ  
        files = {  
            'file': open(file_path, 'rb')  
        }        # ç™¼é€ POST è«‹æ±‚  
        response = requests.post(api_endpoint, headers=headers, data=data, files=files)  
  
        # æª¢æŸ¥å›æ‡‰  
        if response.status_code == 200:  
            print('æ–‡ä»¶æˆåŠŸä¸Šå‚³è‡³ Dify')  
        else:  
            print(f'ä¸Šå‚³å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: {response.status_code}, å›æ‡‰: {response.text}')
```

ç¨‹å¼ä½¿ç”¨ç¯„ä¾‹ï¼Œä»¥ä¸‹åƒæ•¸çš†ä¾†è‡ª`setting.py`åƒæ•¸è¨­å®šæª”å‚³å…¥
```python
# ä½¿ç”¨ç¯„ä¾‹  
txt_filename = TXT_FILENAME  
dataset_id = DATASET_ID  # è«‹æ›¿æ›ç‚ºæ‚¨çš„ dataset_id
document_id = DOCUMENT_ID  # æ›¿æ›ç‚ºæ‚¨çš„ document_id
api_key = DOCUMENT_API_KEY  # è«‹æ›¿æ›ç‚ºæ‚¨çš„ API é‡‘é‘°   
upload_to_dify(txt_filename, dataset_id, document_id, api_key)
```


### 1.3.5. `LINEBOT`èˆ‡`difyçŸ¥è­˜åº«`é€²è¡Œä¸²æ¥


#### 1.3.5.1. `LINEBOT`èˆ‡`difyåƒæ•¸è¨­å®š

```python
from flask import Flask, request, abort  
from linebot import LineBotApi, WebhookHandler  
from linebot.exceptions import InvalidSignatureError  
from linebot.models import MessageEvent, TextMessage, TextSendMessage,FollowEvent, UnfollowEvent  
import requests  
import re  
import json  
from urllib.parse import unquote  
from setting import ACCESS_TOKEN, SECRET,API_ENDPOINT,DIFY_API_KEY  
app = Flask(__name__)  
  
# LINE Bot è³‡è¨Š  
line_bot_api = LineBotApi(ACCESS_TOKEN)  
handler = WebhookHandler(SECRET)  
  
# Dify API URL  
DIFY_API_URL = f'{API_ENDPOINT}/v1/chat-messages'  
DIFY_API_KEY = DIFY_API_KEY  
```


#### 1.3.5.2. LINEBOT WEBHOOK CALLBACKç¨‹å¼

```python
# Webhook è·¯å¾‘ï¼Œè¨­å®šç‚º LINE Webhook URL@app.route("/callback", methods=['POST'])  
def callback():  
    signature = request.headers['X-Line-Signature']  
    body = request.get_data(as_text=True)  
  
    try:  
        handler.handle(body, signature)  
    except InvalidSignatureError:  
        abort(400)  
  
    return 'OK'
```

LINE WEBHOOKä¸²æ¥é€²å…¥é» 

```python
# LINE WEBHOOKä¸²æ¥é€²å…¥é»  
@app.route("/", methods=['POST'])  
def linebot():  
    body = request.get_data(as_text=True)  # å–å¾—æ”¶åˆ°çš„è¨Šæ¯å…§å®¹  
    signature = request.headers['X-Line-Signature']  # åŠ å…¥å›å‚³çš„ headers    try:  
        handler.handle(body, signature)  # ç¶å®šè¨Šæ¯å›å‚³çš„ç›¸é—œè³‡è¨Š  
        json_data = json.loads(body)  # json æ ¼å¼åŒ–è¨Šæ¯å…§å®¹  
    except InvalidSignatureError:  
        abort(400)  
    except Exception as e:  
        print(f"Error: {e}")  # å°å‡ºéŒ¯èª¤è¨Šæ¯  
        print(body)  # å°å‡ºæ”¶åˆ°çš„å…§å®¹  
  
    return 'OK'  # é©—è­‰ Webhook ä½¿ç”¨ï¼Œä¸èƒ½çœç•¥
```

#### 1.3.5.3. LINEBOT ç›¸é—œäº‹ä»¶é‚è¼¯è™•ç†
```python
# è™•ç†åŠ å…¥å¥½å‹äº‹ä»¶  
@handler.add(FollowEvent)  
def handle_follow(event):  
    user_id = event.source.user_id  
    profile = line_bot_api.get_profile(user_id)  
    user_name = profile.display_name  
  
    # æ–°ç”¨æˆ¶æœƒçœ‹åˆ°çš„è¨Šæ¯  
    welcome_message = f"æ‚¨å¥½ï¼š{user_name}\næ„Ÿè¬æ‚¨åŠ å…¥å¥½å‹ğŸ˜˜\næ­¡è¿ä½¿ç”¨å¨›æ¨‚æ–°èåŠ©æ‰‹ğŸ˜ï¼\nä½ å¯ä»¥è«‹AIåšçš„äº‹æƒ…æœ‰:\n1.å»¢è©±ä¸å¤šèªªï¼Œç›´æ¥æŸ¥é©—AIèº«åˆ†\n2.å‘½ä»¤AIå«ä»–å¹«ä½ æŸ¥æ–°èï¼Œè®“AIç´¯æ­»\nä½¿ç”¨æ•™å­¸å¦‚ä¸‹ï¼š\n1.ç¯„ä¾‹1ï¼šä½ æ˜¯èª°???\n2.ï¸ ï¸ç¯„ä¾‹2ï¼šè«‹å‘Šè¨´æˆ‘æœ€æ–°çš„10å‰‡æ–°è"  
    line_bot_api.reply_message(  
        event.reply_token,  
        TextSendMessage(text=welcome_message)  
    )  
  
# è™•ç†å°é–å’Œé‡æ–°åŠ å…¥å¥½å‹äº‹ä»¶  
@handler.add(UnfollowEvent)  
def handle_unfollow(event):  
    user_id = event.source.user_id  
    profile = line_bot_api.get_profile(user_id)  
    user_name = profile.display_name  
  
    # æ–°ç”¨æˆ¶æœƒçœ‹åˆ°çš„è¨Šæ¯  
    welcome_message = f"æ­¡è¿æ‚¨é‡æ–°åŠ å…¥, {user_name}ï¼\nä½ å¯ä»¥è«‹AIåšçš„äº‹æƒ…æœ‰:\n1.å»¢è©±ä¸å¤šèªªï¼Œç›´æ¥æŸ¥é©—AIèº«åˆ†\n2.å‘½ä»¤AIå«ä»–å¹«ä½ æŸ¥æ–°èï¼Œè®“AIç´¯æ­»\nä½¿ç”¨æ•™å­¸å¦‚ä¸‹ï¼š\n1.ç¯„ä¾‹1ï¼šä½ æ˜¯èª°???\n2.ï¸ ï¸ç¯„ä¾‹2ï¼šè«‹å‘Šè¨´æˆ‘æœ€æ–°çš„10å‰‡æ–°è"  
    line_bot_api.reply_message(  
        event.reply_token,  
        TextSendMessage(text=welcome_message)  
    )
```


#### 1.3.5.4. LINEBOT ä¸»ç¨‹å¼é‚è¼¯è™•ç†(è² è²¬æ¥æ”¶ä½¿ç”¨å‚³ééä¾†çš„è¨Šæ¯èˆ‡å›æ‡‰)

```python

# è™•ç† LINE å‚³é€éä¾†çš„è¨Šæ¯  
@handler.add(MessageEvent, message=TextMessage)  
def handle_message(event):  
    user_message = event.message.text  
  
    # å‚³é€è¨Šæ¯åˆ° Dify
    headers = {  
        'Authorization': f'Bearer {DIFY_API_KEY}',  
        'Content-Type': 'application/json'  
    }  
  
    payload = {  
        "inputs": {},  
        "query": user_message,  
        "response_mode": "blocking",  
        "conversation_id": "",  
        "user": "abc-123"  
    }  
  
    try:  
        dify_response = requests.post(DIFY_API_URL, headers=headers, json=payload)  
  
        if dify_response.status_code == 200:  
            # æå– JSON å›æ‡‰å…§å®¹  
            dify_reply = dify_response.json()  
  
            # å‡è¨­ 'answer' æ¬„ä½ä¸­åŒ…å«æ‰€éœ€çš„å…§å®¹  
            answer_content = dify_reply.get('answer', '')  
  
            # ä½¿ç”¨æ­£è¦è¡¨ç¤ºå¼ç§»é™¤ <context> å’Œ </context> æ¨™ç±¤åŠå…¶ä¸­çš„å…§å®¹  
            cleaned_content = re.sub(r'<context>.*?</context>', '', answer_content, flags=re.DOTALL).strip()  
  
            # ä½¿ç”¨æ­£è¦è¡¨ç¤ºå¼æ‰¾åˆ° URLï¼Œä¸¦è§£ç¢¼å®ƒ  
            url_pattern = r'https?://[^\s]+'  
            urls = re.findall(url_pattern, cleaned_content)  
  
            # è§£ç¢¼ URLs            
            for url in urls:  
                decoded_url = unquote(url)  
                cleaned_content = cleaned_content.replace(url, decoded_url)  
  
            # å›å‚³ Dify çš„å›è¦†åˆ° LINE            
            line_bot_api.reply_message(  
                event.reply_token,  
                TextSendMessage(text=cleaned_content)  
            )        else:  
            print(f'API Error: {dify_response.status_code}, Response: {dify_response.text}')  
            line_bot_api.reply_message(  
                event.reply_token,  
                TextSendMessage(text=f'Dify å›æ‡‰å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: {dify_response.status_code}')  
            )    except Exception as e:  
        line_bot_api.reply_message(  
            event.reply_token,  
            TextSendMessage(text=f'ç™¼ç”ŸéŒ¯èª¤: {str(e)}')  
        )
```

#### 1.3.5.5. ä½¿ç”¨`python flask`å•Ÿå‹•`server`

```python
if __name__ == "__main__":  
    app.run(host='0.0.0.0', port=5000)
```


### 1.3.6. éƒ¨ç½²`LINEBOT`åˆ°`docker`

#### 1.3.6.1. æ’°å¯«dockerfile

```docker
# ä½¿ç”¨ Pythonéƒ¨ç½²Flaskå¾Œç«¯æ¡†æ¶  
FROM python:3.8  
# è¨­å®šå·¥ä½œç›®éŒ„  
WORKDIR /usr/src/app  
# è¤‡è£½æ‰€éœ€æª”æ¡ˆåˆ°å®¹å™¨å…§  
COPY . .  
RUN pip install --no-cache-dir -r requirements.txt  
# æš´éœ²ç«¯å£  
EXPOSE 5000  
# å•Ÿå‹•Flask  
CMD ["python", "LinebotWithDify.py"]
```

#### 1.3.6.2. æ’°å¯«docker-compose.yml

```docker
version: '3.8'  
  
services:  
  python:  
    build:  
      context: .  # Dockerfile çš„ä½ç½®  
      dockerfile: Dockerfile  # è‡ªå®šç¾© Dockerfile çš„åç¨±  
    container_name: LinebotWithDify  
    ports:  
      - "5000:5000"  
    volumes:  
      - C:\WorkSpace\yahooNewFetch_LINEBOT:/usr/src/app  
    networks:  
      - python_network  
  
networks:  
  python_network:

```

#### 1.3.6.3. éƒ¨ç½²åˆ°docker

å°‡ç›¸é—œpythonæª”æ¡ˆåŠä¸Šé¢å¯«å¥½çš„è…³æœ¬æ”¾ç½®åŒä¸€å€‹ç›®éŒ„ï¼ŒåŸ·è¡Œä»¥ä¸‹å‘½ä»¤

```docker
docker-compose up -d
```

![](https://markweb.idv.tw/uploads/202410132025602.png)

é€²å…¥docker-desktop æŸ¥çœ‹ï¼Œç¢ºèªå®¹å™¨æ­£å¸¸åŸ·è¡Œ

![](https://markweb.idv.tw/uploads/202410132026478.png)


![](https://markweb.idv.tw/uploads/202410132027084.png)


### 1.3.7. éƒ¨ç½² Stable Diffusion WebUIåˆ°`docker`

ç¢ºèªDockerèªå¾—åˆ°ä½ çš„Nvidiaé¡¯ç¤ºå¡é©…å‹•ç‰ˆæœ¬

```docker
docker run --rm --runtime=nvidia --gpus all nvidia/cuda:11.6.2-base-ubuntu20.04 nvidia-smi
```

è¤‡è£½AbdBarhoçš„å„²å­˜åº«

```bash
git clone https://github.com/AbdBarho/stable-diffusion-webui-docker.git

cd stable-diffusion-webui-docker
```


ä¸‹è¼‰å¿…è¦Stable Diffusionæ¨¡å‹

```docker
docker compose --profile download up --build
```


å•Ÿå‹•å®¹å™¨

```docker
docker compose --profile auto up
```


![](https://markweb.idv.tw/uploads/202410162106841.png)


ç­‰å¾…å®¹å™¨å•Ÿå‹•å®Œæˆï¼Œç”¨ç€è¦½å™¨é–‹å•Ÿ`http://localhost:7860`é€²å…¥WebUI

![](https://markweb.idv.tw/uploads/202410162106459.png)

### 1.3.8. Stable Diffusion WebUIåŸºç¤è¨­å®š

é»æ“ŠExtensions->Install from URL -> URL for extension's git repository ->å°‡ä¸‹æ–¹ç¶²é èªªæ˜çš„å…§å®¹è¦ºå¾—æœ‰éœ€è¦å°±`å®‰è£`ï¼Œç®—æ˜¯`å¤–æ›å¢å¼·`çš„ä¸€éƒ¨åˆ†

https://www.chias.com.tw/%e3%80%90stable-diffusion%e3%80%91%e5%bf%85%e8%a3%9d%e6%93%b4%e5%85%85/

![](https://markweb.idv.tw/uploads/202410162109566.png)


### 1.3.9. Stable Diffusion è‡ªå®šç¾©APIä¸²æ¥

1. å› ç‚ºdifyç¾æœ‰çš„åŠŸèƒ½`éå¸¸ç°¡é™‹`ï¼Œé€™é‚Šå»ºè­°æ‰‹å‹•é–‹ç™¼
2. æ­¤æ­¥é©Ÿæœ‰ç”¨åˆ°`Firebase Storage`ï¼Œç”¨ä¾†å°‡æ¨¡å‹ç”Ÿæˆçš„åœ–ç‰‡ä¸Šå‚³è‡³å…¬é–‹å¹³å°ï¼Œå–å¾—ç¶²å€å¾Œå›å‚³ï¼Œå› æ­¤`stable-diffusion-customapi-firebase-adminsdk-bzguv-d0beefeec8.json`æ˜¯Firebaseçš„è¨­å®šæª”
#### 1.3.9.1. æ’°å¯«dockerfile

```docker
# ä½¿ç”¨å®˜æ–¹ Python æ˜ åƒ
FROM python:3.9-slim

# è¨­å®šå·¥ä½œç›®éŒ„
WORKDIR /app

# è¤‡è£½ç•¶å‰ç›®éŒ„çš„å…§å®¹åˆ°å®¹å™¨ä¸­
COPY . /app

# å®‰è£å¿…è¦çš„ Python å¥—ä»¶
RUN pip install flask requests flask_cors flask-openapi3 firebase-admin

# å°å¤–æš´éœ² 5000 port
EXPOSE 5000

# åŸ·è¡Œ Flask æ‡‰ç”¨ç¨‹å¼
CMD ["python", "app.py"]
```

#### 1.3.9.2. æ’°å¯«docker-compose.yml

```docker
version: '3.8'

services:
  stable-diffusion-flask-api:
    build: .
    ports:
      - "5001:5000"
    volumes:
      - C:\WorkSpace\stable-diffusion-customAPI:/app  # æ›è¼‰ volume
```

#### 1.3.9.3. æ’°å¯«app.py

```python
from flask import Flask, request, jsonify
from flask_openapi3 import OpenAPI, Info, Tag, Server
from flask_openapi3.models import Response
from pydantic import BaseModel, Field
from flask_cors import CORS
import requests
import base64
import os
from datetime import datetime
import firebase_admin
from firebase_admin import credentials, storage

info = Info(title='Stable Diffusion API', version='1.0', description='ä½¿ç”¨ Stable Diffusion WebUI ç”Ÿæˆåœ–åƒçš„ API')
servers = [
    Server(url="http://163.14.137.66:5001", description="åœ°ç«¯Stable Diffusion WebUI")
]
generate_tag = Tag(name='generate', description='åœ–åƒç”Ÿæˆæ“ä½œ')
app = OpenAPI(__name__, info=info, servers=servers)


# åˆå§‹åŒ– Firebase Admin SDK
cred = credentials.Certificate("/app/stable-diffusion-customapi-firebase-adminsdk-bzguv-d0beefeec8.json")
firebase_admin.initialize_app(cred, {
    'storageBucket': 'stable-diffusion-customapi.appspot.com'
})

# åœ–ç‰‡å„²å­˜è·¯å¾‘
IMAGE_FOLDER = '/app/images'
os.makedirs(IMAGE_FOLDER, exist_ok=True)

# Stable Diffusion WebUI API endpoint (é è¨­ç¶²å€)
STABLE_DIFFUSION_API = "http://163.14.137.66:7860/sdapi/v1/txt2img"

class GenerateImageParams(BaseModel):
    prompt: str = Field(..., description='ç”¨æ–¼ç”Ÿæˆåœ–åƒçš„æç¤º')  # å¿…å¡«
    steps: int = Field(30, description='å–æ¨£æ­¥é©Ÿæ•¸')  # é è¨­å€¼ 30ï¼Œéå¿…å¡«
    width: int = Field(512, description='åœ–åƒå¯¬åº¦')  # é è¨­å€¼ 512ï¼Œéå¿…å¡«
    height: int = Field(512, description='åœ–åƒé«˜åº¦')  # é è¨­å€¼ 512ï¼Œéå¿…å¡«
    cfg_scale: float = Field(7.0, description='CFG æ¯”ä¾‹')  # é è¨­å€¼ 7.0ï¼Œéå¿…å¡«
    negative_prompt: str = Field('', description='ç”Ÿæˆåœ–åƒæ™‚è¦é¿å…çš„å…§å®¹')  # é è¨­å€¼ ç©ºå­—ä¸²ï¼Œéå¿…å¡«
    seed: int = Field(-1, description='éš¨æ©Ÿç¨®å­')  # é è¨­å€¼ -1ï¼Œéå¿…å¡«
    sampler_name: str = Field('DPM++ 2M', description='å–æ¨£æ–¹æ³•')  # é è¨­å€¼ 'DPM++ 2M'ï¼Œéå¿…å¡«
    batch_size: int = Field(1, description='æ‰¹æ¬¡å¤§å°')  # é è¨­å€¼ 1ï¼Œéå¿…å¡«
    face_detector: str = Field('face_yolov8n.pt', description='ä½¿ç”¨çš„è‡‰éƒ¨æª¢æ¸¬æ¨¡å‹')  # é è¨­å€¼ 'face_yolov8n.pt'ï¼Œéå¿…å¡«
    hand_detector: str = Field('hand_yolov8n.pt', description='ä½¿ç”¨çš„æ‰‹éƒ¨æª¢æ¸¬æ¨¡å‹')  # é è¨­å€¼ 'hand_yolov8n.pt'ï¼Œéå¿…å¡«
    person_detector: str = Field('person_yolov8n-seg.pt', description='ä½¿ç”¨çš„äººé«”æª¢æ¸¬æ¨¡å‹')  # é è¨­å€¼ 'person_yolov8n-seg.pt'ï¼Œéå¿…å¡«

class GenerateImageResponse(BaseModel):
    image_url: str = Field(..., description='ç”Ÿæˆåœ–åƒçš„å…¬é–‹ URL')

class ErrorResponse(BaseModel):
    status: str = Field('error', description='éŒ¯èª¤ç‹€æ…‹')
    message: str = Field(..., description='éŒ¯èª¤ä¿¡æ¯')

@app.post(
    '/generate',
    tags=[generate_tag],
    summary='ä½¿ç”¨ Stable Diffusion ç”Ÿæˆåœ–åƒ',
    description='æ ¹æ“šæä¾›çš„æç¤ºç”Ÿæˆåœ–åƒ',
    responses={'200': GenerateImageResponse, '500': ErrorResponse}
)
def generate_image(body: GenerateImageParams):
    """
    Generate an image using Stable Diffusion based on the provided parameters.
    """
    try:
        # ç™¼é€ API è«‹æ±‚è‡³ Stable Diffusion WebUI
        payload = {
            "prompt": body.prompt,
            "negative_prompt": body.negative_prompt,
            "steps": body.steps,
            "width": body.width,
            "height": body.height,
            "cfg_scale": body.cfg_scale,
            "seed": body.seed,
            "sampler_name": body.sampler_name,
            "batch_size": body.batch_size,
            "face_detector": body.face_detector,
            "hand_detector": body.hand_detector,
            "person_detector": body.person_detector,
        }
        response = requests.post(STABLE_DIFFUSION_API, json=payload)

        if response.status_code == 200:
            result = response.json()
            # è§£ç¢¼ Base64 åœ–ç‰‡
            image_data = result['images'][0]
            image_bytes = base64.b64decode(image_data)
            timestamp = datetime.now().strftime('%Y%m%d%H%M%S')
            filename = f'generated_image_{timestamp}.png'

            # å°‡åœ–ç‰‡å­˜ç‚º PNG æª”æ¡ˆ
            image_path = os.path.join(IMAGE_FOLDER, filename)
            with open(image_path, 'wb') as f:
                f.write(image_bytes)

            # å°‡åœ–ç‰‡ä¸Šå‚³è‡³ Firebase Storage
            bucket = storage.bucket()
            blob = bucket.blob(f"images/{filename}")
            blob.upload_from_filename(image_path)
            blob.make_public()

            # ç²å–å…¬é–‹çš„åœ–ç‰‡ URL
            image_url = blob.public_url

            # å›å‚³åœ–ç‰‡çš„å…¬é–‹ URL
            return image_url,200
        else:
            return ErrorResponse(message=f"Stable Diffusion API error: {response.text}"), 500
    except Exception as e:
        return ErrorResponse(message=f"Internal server error: {str(e)}"), 500

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
```


å•Ÿå‹•å®¹å™¨

```docker
docker-compose up -d
```


![](https://markweb.idv.tw/uploads/202410162124891.png)

### 1.3.10. difyå·¥ä½œæµå»ºç«‹

#### 1.3.10.1. å•é¡Œåˆ†é¡

ä¸»è¦åˆ†ç‚ºæ–°èã€åœ–ç‰‡ã€å•å€™èªã€å…¶ä»–ï¼Œæ ¹æ“šä¸åŒçš„æµç¨‹æœƒåˆ°é”ä¸åŒçš„åœ°æ–¹

![](https://markweb.idv.tw/uploads/202410162127158.png)

#### 1.3.10.2. çŸ¥è­˜åº«å»ºç«‹

é€™é‚Šå°‡å…ˆå‰æ’°å¯«çš„`pythonçˆ¬èŸ²ç¨‹å¼`çµæœæœƒå¯«å…¥é€™å€‹`çŸ¥è­˜åº«`ï¼Œé€™è£¡å°±å¯ä»¥ç›´æ¥ä½¿ç”¨

![](https://markweb.idv.tw/uploads/202410162129907.png)


![](https://markweb.idv.tw/uploads/202410162129527.png)


#### 1.3.10.3. åˆ¤æ–·æå•ç›¸é—œæ€§-LLM

é€™å€‹æ­¥é©Ÿæ˜¯åˆ¤æ–·ä½¿ç”¨è€…çš„æå•å’ŒçŸ¥è­˜åº«æ˜¯å¦æœ‰ç›¸é—œï¼Œæœƒå›å‚³ä¸€å€‹çµæœï¼Œç”¨æ–¼å¾ŒçºŒçš„åˆ¤æ–·

![](https://markweb.idv.tw/uploads/202410162131168.png)

#### 1.3.10.4. JSON Parse

é€™å€‹æ­¥é©Ÿæ˜¯ç‚ºäº†è§£æå‰›æ‰çš„çµæœï¼Œå› ç‚ºå›å‚³æ˜¯JSONæ ¼å¼

![](https://markweb.idv.tw/uploads/202410162133054.png)

#### 1.3.10.5. æ¢ä»¶åˆ¤æ–·

é€™å€‹æ­¥é©Ÿæ˜¯ç‚ºäº†åˆ¤æ–·ï¼Œè‹¥æå•ä¸ç›¸é—œå°±èµ°ä¸Šæ–¹ï¼Œæå•ç›¸é—œå°±èµ°ä¸‹æ–¹

![](https://markweb.idv.tw/uploads/202410162134124.png)

#### 1.3.10.6. GoogleSearch

é€™å€‹æ­¥é©Ÿæ˜¯å¦‚æœæå•ä¸ç›¸é—œï¼Œå°±ä¸²æ¥æ­¤APIç›´æ¥å¾`ç¶²è·¯æŸ¥è©¢`è³‡æ–™

![](https://markweb.idv.tw/uploads/202410162135551.png)

#### 1.3.10.7. Jsonæ ¼å¼è½‰å­—ä¸²ç¨‹å¼ç¢¼

é€™å€‹æ­¥é©Ÿæ˜¯ç‚ºäº†å°‡google searchçš„å›å‚³çµæœè½‰æ›ç‚ºå­—ä¸²ï¼Œå› ç‚º`LLM`çš„ä¸åƒ`JSONæ ¼å¼`
```python
import json
def main(http_response: str) -> str:
Â  Â  # å¦‚æœå‚³å…¥çš„ http_response å·²æ˜¯ Python ç‰©ä»¶ï¼ˆdictï¼‰ï¼Œå‰‡ç„¡éœ€è§£æ
Â  Â  if isinstance(http_response, str):
Â  Â  Â  Â  data = json.loads(http_response) Â # å°‡ JSON å­—ä¸²è½‰æ›ç‚º Python å­—å…¸
Â  Â  else:
Â  Â  Â  Â  data = http_response Â # å·²æ˜¯ Python å­—å…¸
Â  Â  # å°‡ organic_results è½‰ç‚º JSON å­—ä¸²æ ¼å¼
Â  Â  return {'result':json.dumps(data, ensure_ascii=False, indent=4)}
```

#### 1.3.10.8. æ ¹æ“šgoogleå›è¦†-LLM

é€™å€‹æ­¥é©Ÿç”¨ä¾†æ’°å¯«ä¸€æ®µæç¤ºè©ï¼Œæ ¹æ“šä½¿ç”¨è€…çš„è©¢å•å›å‚³é©ç•¶çš„çµæœ

![](https://markweb.idv.tw/uploads/202410162139647.png)

#### 1.3.10.9. GOOGLESEARCHå•é¡Œå›è¦†

ç”¨æ–¼æœ€çµ‚çµæœå‘ˆç¾

![](https://markweb.idv.tw/uploads/202410162141915.png)

#### 1.3.10.10. æ ¹æ“šçŸ¥è­˜åº«å›è¦†-LLM

é€™å€‹æ­¥é©Ÿç”¨ä¾†æ’°å¯«ä¸€æ®µæç¤ºè©ï¼Œæ ¹æ“šä½¿ç”¨è€…çš„è©¢å•å›å‚³é©ç•¶çš„çµæœ

![](https://markweb.idv.tw/uploads/202410162142926.png)

#### 1.3.10.11. çŸ¥è­˜åº«å•é¡Œå›è¦†

ç”¨æ–¼æœ€çµ‚çµæœå‘ˆç¾

![](https://markweb.idv.tw/uploads/202410162143590.png)


#### 1.3.10.12. å»ºç«‹è‡ªå®šç¾©å°å·¥å…·

è«‹å…ˆé€²å…¥é€™å€‹ç¶²å€
http://localhost:5001/openapi/swagger

é»æ“Šæ­¤é€£çµ

![](https://markweb.idv.tw/uploads/202410162146474.png)

æŠŠé€™æ•´æ®µèªæ³•è¤‡è£½èµ·ä¾†

![](https://markweb.idv.tw/uploads/202410162147027.png)


é»æ“Šå·¥å…·->è‡ªå®šç¾© -> å»ºç«‹è‡ªå®šç¾©å·¥å…·
1. è¼¸å…¥å·¥å…·åç¨±
2. è²¼ä¸Šå‰›æ‰è¤‡è£½çš„èªæ³•
3. ç¢ºèªèªæ³•ç„¡èª¤ï¼Œè‹¥æœ‰éŒ¯èª¤ç¶²ç«™æœƒç›´æ¥è·³å‡ºéŒ¯èª¤è¨Šæ¯
4. å¯ç”¨å·¥å…·æ—é‚Šæœ‰æ¸¬è©¦æŒ‰éˆ•å¯é»æ“Šæ¸¬è©¦ï¼Œé€™é‚Šå°±ä¸ç¤ºç¯„
5. é»æ“Šå„²å­˜

![](https://markweb.idv.tw/uploads/202410162148202.png)

#### 1.3.10.13. è‡ªå®šç¾©å°å·¥å…·æµç¨‹è¨­å®š

generate_image_generate_post

é€™è£¡å”¯ä¸€çš„å¿…å¡«æ¬„ä½æ˜¯promtï¼Œå…¶é¤˜éƒ½æ˜¯éå¿…å¡«(è¶…åƒæ•¸)

![](https://markweb.idv.tw/uploads/202410162151974.png)


![](https://markweb.idv.tw/uploads/202410162152075.png)


![](https://markweb.idv.tw/uploads/202410162152714.png)


#### 1.3.10.14. åˆ¤æ–·æ¢ä»¶è¨­å®š

å› ç‚ºé€™é‚Šæƒ³è¦ä¸²æ¥åˆ°`LINEBOT`ï¼Œä½†ç™¼ç¾`dify`å’Œ`LINEBOT`å›å‚³æ ¼å¼ä¸åŒï¼Œå› æ­¤é€™é‚Šå¤šäº†ä¸€å€‹åˆ¤æ–·æ¢ä»¶ï¼Œè‹¥å­—è©åŒ…å«`dify`èµ°ä¸Šæ–¹ï¼Œå¦å‰‡èµ°ä¸‹æ–¹

![](https://markweb.idv.tw/uploads/202410162153639.png)


#### 1.3.10.15. åœ–æª”èªæ³•è½‰æ›

é€™é‚Šå¤šäº†ä¸€å€‹èªæ³•è½‰æ›ï¼Œèªæ³•å¦‚ä¸‹

```jinja2
!["åœ–ç‰‡1"]({{ imageURL Â }})
```

![](https://markweb.idv.tw/uploads/202410162155827.png)

#### 1.3.10.16. difyåœ–æª”å‘ˆç¾çµæœ

![](https://markweb.idv.tw/uploads/202410162156819.png)

#### 1.3.10.17. LINEBOTåœ–æª”å‘ˆç¾çµæœ

![](https://markweb.idv.tw/uploads/202410162157069.png)


### 1.3.11. å¤šåœ–æª”å›å‚³é‚è¼¯æ’°å¯«

ä¸»è¦æ˜¯åœ¨`handle_message`å¢åŠ é‚è¼¯åˆ¤æ–·è™•ç†ï¼Œé€™é‚Šæœ‰å€‹é‡è¦çš„åœ°æ–¹æ˜¯`image_url`å¿…é ˆæ˜¯`å…¬é–‹çš„ç¶²å€`ï¼Œè‹¥æ˜¯`ç§äººç¶²å€`å¯èƒ½æœƒå°è‡´åœ–ç‰‡å›å‚³å‘ˆç¾æœ‰å•é¡Œã€‚

```python
    if dify_response.status_code == 200:
            # æå– JSON å›æ‡‰å…§å®¹
            dify_reply = dify_response.json()
            # å‡è¨­ 'answer' æ¬„ä½ä¸­åŒ…å«æ‰€éœ€çš„å…§å®¹
            answer_content = dify_reply.get('answer', '')
            # ä½¿ç”¨æ­£è¦è¡¨ç¤ºå¼ç§»é™¤ <context> å’Œ </context> æ¨™ç±¤åŠå…¶ä¸­çš„å…§å®¹
            cleaned_content = re.sub(r'<context>.*?</context>', '', answer_content, flags=re.DOTALL).strip()
            # ä½¿ç”¨æ­£è¦è¡¨ç¤ºå¼æ‰¾åˆ° URLï¼Œä¸¦è§£ç¢¼å®ƒ
            url_pattern = r'https?://[^\s]+'
            urls = re.findall(url_pattern, cleaned_content)
            # è§£ç¢¼ URLs
            image_url = None
            for url in urls:
                decoded_url = unquote(url)
                cleaned_content = cleaned_content.replace(url, decoded_url)
                # å¦‚æœæ˜¯åœ–ç‰‡ URLï¼Œå°±å­˜è¨˜ä¸‹ä¾†
                if decoded_url.lower().endswith(('.png', '.jpg', '.jpeg', '.gif')):
                    image_url = decoded_url
            print(f'image_url: {image_url}')
            # å¦‚æœæ˜¯åœ–ç‰‡ URLï¼Œæ­£ç¢ºåœ°ä½¿ç”¨ ImageSendMessage å›å‚³
            messages = [TextSendMessage(text=cleaned_content)]
            if image_url:
                messages = [ImageSendMessage(original_content_url=image_url, preview_image_url=image_url)]
            line_bot_api.reply_message(event.reply_token, messages)
```


### 1.3.12. å¢åŠ é—œéµå­—æœå°‹åœ–ç‰‡åŠŸèƒ½

åƒæ•¸å®šç¾©åŠæ¸¬è©¦å¯ä»¥åƒè€ƒ https://serpapi.com/playground

![](https://markweb.idv.tw/uploads/202410231833269.png)


![](https://markweb.idv.tw/uploads/202410231834468.png)


### 1.3.13. è§£æJSONæ ¼å¼èªæ³•

æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿå»ºç«‹
1. è¼¸å…¥è®Šé‡åç¨±->http_response
2. è®Šæ•¸é¸æ“‡body
3. è²¼ä¸Šä¸‹æ–¹çš„pythonèªæ³•
4. è¼¸å‡ºè®Šé‡åç¨±->imageURLs
5. å›å‚³æ ¼å¼->é€™é‚Šè¦é¸æ“‡`Array[Object]`ï¼Œä¸æ˜¯`String`

![](https://markweb.idv.tw/uploads/202410231837081.png)

```python
import json
import random
import re

def main(http_response: str) -> list:
Â  Â  try:
Â  Â  Â  Â  # å°‡ http_response è½‰æ›ç‚º Python å­—å…¸
Â  Â  Â  Â  data = json.loads(http_response)
Â  Â  Â  Â  
Â  Â  Â  Â  # ç¢ºä¿ images_results å­˜åœ¨ä¸¦ä¸”æ˜¯åˆ—è¡¨
Â  Â  Â  Â  images_results = data.get('images_results', [])
Â  Â  Â  Â  
Â  Â  Â  Â  if not isinstance(images_results, list):
Â  Â  Â  Â  Â  Â  return [{'error': 'images_results is not a valid list'}]
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  # éæ¿¾å‡ºå‰¯æª”åç‚º .jpgã€.jpegã€.png çš„åœ–ç‰‡
Â  Â  Â  Â  valid_images = [item for item in images_results if isinstance(item, dict) and 'thumbnail' in item and re.search(r'\.(jpg|jpeg|png)$', item['thumbnail'], re.IGNORECASE)]

  
Â  Â  Â  Â  # éš¨æ©Ÿé¸å– 5 å€‹ thumbnail URLï¼ˆå¦‚æœåˆ—è¡¨ä¸­å°‘æ–¼ 5 å€‹ï¼Œå‰‡è¿”å›æ‰€æœ‰ï¼‰
Â  Â  Â  Â  random_images = random.sample(valid_images, min(5, len(valid_images)))
Â  Â  Â  Â  image_urls = [{'thumbnail': item['thumbnail']} for item in random_images]


Â  Â  Â  Â  # è¿”å›éš¨æ©Ÿ 5 å€‹åœ–ç‰‡çš„ URL åˆ—è¡¨
Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  'imageURLs': image_urls
Â  Â  Â  Â  }

Â  Â  except json.JSONDecodeError:
Â  Â  Â  Â  # æ•æ‰ JSON è§£æéŒ¯èª¤
Â  Â  Â  Â  return [{'error': 'Invalid JSON format'}]

Â  Â  except TypeError as e:
Â  Â  Â  Â  # æ•æ‰å…¶ä»–å¯èƒ½çš„éŒ¯èª¤
Â  Â  Â  Â  return [{'error': f'An unexpected error occurred: {str(e)}'}]

Â  Â  except ValueError:
Â  Â  Â  Â  # æ•æ‰ random.sample çš„éŒ¯èª¤ï¼ˆå¦‚åˆ—è¡¨ç‚ºç©ºæ™‚ï¼‰
Â  Â  Â  Â  return [{'error': 'No images available to select'}]
```


### 1.3.14. æœåœ–åœ–æª”èªæ³•è½‰æ›

æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿå»ºç«‹
1. è¼¸å…¥è®Šé‡åç¨±->imageURLs
2. è®Šæ•¸é¸æ“‡è§£æå®Œæˆå¾Œçš„`Array[Object]`
3. è²¼ä¸Šä¸‹æ–¹çš„pythonèªæ³•
4. è¼¸å‡ºè®Šé‡åç¨±->imageURLs
5. å›å‚³æ ¼å¼->é€™é‚Šè¦é¸æ“‡`Array[Object]`ï¼Œä¸æ˜¯`String`

![](https://markweb.idv.tw/uploads/202410231902898.png)

```Jinja2
{% for item in imageURLs %}
![åœ–ç‰‡{{ loop.index }}]({{ item.thumbnail }})
{% endfor %}
```

### 1.3.15. æœåœ–åœ–æª”å‘ˆç¾

å°‡å‰ä¸€æ­¥é©Ÿè¼¸å‡ºçš„è®Šæ•¸æ”¾å…¥æ¨¡æ¿å…§å³å¯

![](https://markweb.idv.tw/uploads/202410231907038.png)


### 1.3.16. LINEBOTé‚è¼¯æ”¹å¯«

æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿå»ºç«‹
1. å¢åŠ å•å€™èªã€AIæ–‡ç”Ÿåœ–åˆ¤æ–·é‚è¼¯ï¼Œç¬¦åˆæ¢ä»¶å›å‚³ç›¸å°æ‡‰çš„æ–‡å­—åŠè²¼åœ–
2. å®£å‘Šé™£åˆ—å­˜æ”¾`image_urls`ï¼Œè‹¥ç”Ÿæˆçš„æ˜¯åœ–ç‰‡ï¼Œå‰‡å…ˆå›å‚³åœ–ç‰‡å†å‚³æ–‡å­—ï¼Œè‹¥ç”Ÿæˆçš„æ˜¯æ–‡å­—ï¼Œå‰‡ç›´æ¥å›å‚³æ–‡å­—è¨Šæ¯


```python
# è™•ç† LINE å‚³é€éä¾†çš„è¨Šæ¯  
@handler.add(MessageEvent, message=TextMessage)  
def handle_message(event):  
    user_message = event.message.text  
  
    # åˆ¤æ–·æ˜¯å¦ç‚ºå•å€™èª  
    greetings = ["ä½ å¥½", "å—¨", "å“ˆå›‰", "æ‚¨å¥½", "æ—©å®‰", "æ™šå®‰", "hi", "hello"]  
    if not any(greeting.lower() in user_message.lower() for greeting in greetings):  
        # å…ˆä½¿ç”¨ push_message å›æ‡‰ç”¨æˆ¶ä¸€å€‹ã€ŒæŸ¥è©¢ä¸­è«‹ç¨å€™ã€çš„è¨Šæ¯å’Œè²¼åœ–  
        line_bot_api.push_message(  
            event.source.user_id,  
            [                TextSendMessage(text="æ”¶åˆ°æ‚¨çš„é—œéµå­—è¼¸å…¥ï¼Œæˆ‘æ­£åœ¨é€²è¡ŒæŸ¥è©¢è™•ç†...ï¼Œè«‹ç¨å€™å¤§ç´„ä¸€åˆ†é˜å·¦å³..."),  
                StickerSendMessage(package_id="6362", sticker_id="11087930"),  
                StickerSendMessage(package_id="6362", sticker_id="11087931")  
            ]        )    
    else:  
        line_bot_api.push_message(  
            event.source.user_id,  
            [                TextSendMessage(text="æ”¶åˆ°æ‚¨çš„ AI é—œéµå­—è¼¸å…¥ï¼Œæˆ‘æ­£åœ¨é€²è¡Œç”Ÿæˆè™•ç†...ï¼Œè«‹ç¨å€™å¤§ç´„ä¸€åˆ†é˜å·¦å³..."),  
                StickerSendMessage(package_id="6362", sticker_id="11087930"),  
                StickerSendMessage(package_id="6362", sticker_id="11087931")  
            ]        )  
    # å‚³é€è¨Šæ¯åˆ° Dify    headers = {  
        'Authorization': f'Bearer {DIFY_API_KEY}',  
        'Content-Type': 'application/json'  
    }  
  
    payload = {  
        "inputs": {},  
        "query": user_message,  
        "response_mode": "blocking",  
        "conversation_id": "",  
        "user": "abc-123"  
    }  
  
    try:  
        dify_response = requests.post(DIFY_API_URL, headers=headers, json=payload)  
  
        if dify_response.status_code == 200:  
            # æå– JSON å›æ‡‰å…§å®¹  
            dify_reply = dify_response.json()  
  
            # å‡è¨­ 'answer' æ¬„ä½ä¸­åŒ…å«æ‰€éœ€çš„å…§å®¹  
            answer_content = dify_reply.get('answer', '')  
  
            # ä½¿ç”¨æ­£è¦è¡¨ç¤ºå¼ç§»é™¤ <context> å’Œ </context> æ¨™ç±¤åŠå…¶ä¸­çš„å…§å®¹  
            cleaned_content = re.sub(r'<context>.*?</context>', '', answer_content, flags=re.DOTALL).strip()  
  
            # ä½¿ç”¨æ­£è¦è¡¨ç¤ºå¼æ‰¾åˆ° URLï¼Œä¸¦è§£ç¢¼å®ƒ  
            url_pattern = r'https?://[^\s]+'  
            urls = re.findall(url_pattern, cleaned_content)  
  
            # è§£ç¢¼ URLs ä¸¦æ”¶é›†åœ–ç‰‡ URL            image_urls = []  
            for url in urls:  
                decoded_url = unquote(url)  
                cleaned_content = cleaned_content.replace(url, decoded_url)  
                # å¦‚æœæ˜¯åœ–ç‰‡ URLï¼Œå°±å­˜è¨˜ä¸‹ä¾†  
                if decoded_url.lower().endswith(('.png', '.jpg', '.jpeg', '.gif')):  
                    image_urls.append(decoded_url)  
            print(f'image_url: {image_urls}')  
            # åˆ†é–‹å›æ‡‰æ¯å€‹åœ–ç‰‡è¨Šæ¯  
            if image_urls:  
                for image_url in image_urls:  
                    line_bot_api.push_message(  
                        event.source.user_id,  
                        ImageSendMessage(original_content_url=image_url, preview_image_url=image_url)  
                    )                    # å‚³é€åœ–ç‰‡çš„é€£çµ  
                    line_bot_api.push_message(  
                        event.source.user_id,  
                        TextSendMessage(text=f"æ‚¨å¥½ï¼Œæ ¹æ“šæ‚¨æŸ¥è©¢çš„é—œéµå­—ã€{user_message}ã€‘\næŸ¥è©¢çš„åœ–ç‰‡çµæœå¦‚ä¸‹â†“\nåœ–ç‰‡é€£çµï¼š{image_url}")  
                    )            
            else:  
                messages = [TextSendMessage(text=cleaned_content)]  
                line_bot_api.reply_message(event.reply_token, messages)  
  
        else:  
            print(f'API Error: {dify_response.status_code}, Response: {dify_response.text}')  
            line_bot_api.reply_message(  
                event.reply_token,  
                TextSendMessage(text=f'Dify å›æ‡‰å¤±æ•—ï¼Œç‹€æ…‹ç¢¼: {dify_response.status_code}')  
            )    except Exception as e:  
        line_bot_api.reply_message(  
            event.reply_token,  
            TextSendMessage(text=f'ç™¼ç”ŸéŒ¯èª¤: {str(e)}')  
        )
```

### 1.3.17. æ¸¬è©¦çµæœ

LINEBOT->æŸ¥è©¢åœ–ç‰‡

![](https://markweb.idv.tw/uploads/202410231914451.png)



LINEBOT->æŸ¥è©¢æ–°è

![](https://markweb.idv.tw/uploads/202410231915578.png)


![](https://markweb.idv.tw/uploads/202410231916202.png)


LINEBOT->AIç”Ÿæˆåœ–ç‰‡

![](https://markweb.idv.tw/uploads/202410231917339.png)

![](https://markweb.idv.tw/uploads/202410231917943.png)